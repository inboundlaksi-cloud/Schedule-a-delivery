<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการคิว</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #f8fafc; --text-color: #1e293b; --card-bg: #ffffff;
            --border-color: #e2e8f0; --accent-color: #6366f1; --accent-hover: #4f46e5;
            --success-color: #10b981; --warning-color: #f59e0b; --error-color: #ef4444;
            --today-bg: #fef3c7; --today-text: #92400e; --hover-bg: #f1f5f9;
            --chat-bg: #f0f9ff; --chat-sent: #dbeafe; --chat-received: #e0e7ff;
        }
        * { font-family: 'Sarabun', sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-color); font-size: 16px; min-height: 100vh; }
        .card { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); }
        .card-shadow { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .calendar-day { transition: all 0.2s ease-in-out; cursor: pointer; min-height: 80px; }
        .calendar-day:hover:not(.disabled) { background-color: var(--hover-bg); transform: scale(1.02); }
        .has-bookings { position: relative; }
        .has-bookings::after { content: ''; position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%); width: 6px; height: 6px; background-color: var(--accent-color); border-radius: 50%; }
        .today { background-color: var(--today-bg) !important; color: var(--today-text) !important; font-weight: bold; }
        .staff-nav-btn { display: flex; align-items: center; gap: 8px; padding: 10px 16px; border-radius: 8px; font-weight: 500; transition: all 0.2s; }
        .staff-nav-btn.active { background-color: var(--accent-color); color: white; box-shadow: 0 4px 14px 0 rgba(99, 102, 241, 0.2); }
        .staff-nav-btn:not(.active) { color: var(--text-color); }
        .staff-nav-btn:not(.active):hover { background-color: var(--hover-bg); }
        .icon { width: 1.25rem; height: 1.25rem; }
        .btn { padding: 10px 20px; border-radius: 8px; font-weight: 500; transition: all 0.2s; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background-color: var(--accent-color); color: white; }
        .btn-primary:hover { background-color: var(--accent-hover); }
        .btn-secondary { background-color: #e2e8f0; color: var(--text-color); }
        .btn-secondary:hover { background-color: #cbd5e1; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-danger { background-color: var(--error-color); color: white; }
        .btn-warning { background-color: var(--warning-color); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 14px; }
        .btn-lg { padding: 14px 28px; font-size: 18px; }
        .input { padding: 10px 14px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; transition: border-color 0.2s; }
        .input:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
        .reference-number { font-family: 'Courier New', monospace; font-weight: bold; letter-spacing: 1px; background: linear-gradient(90deg, #6366f1, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .scanner-view { position: relative; width: 100%; max-width: 400px; margin: 0 auto; aspect-ratio: 1; background: #000; border-radius: 12px; overflow: hidden; }
        .scanner-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; }
        .scanner-frame { width: 250px; height: 250px; border: 2px solid var(--accent-color); border-radius: 12px; position: relative; }
        .scanner-frame::before, .scanner-frame::after { content: ''; position: absolute; width: 20px; height: 20px; border: 3px solid var(--accent-color); }
        .scanner-frame::before { top: -2px; left: -2px; border-right: none; border-bottom: none; }
        .scanner-frame::after { bottom: -2px; right: -2px; border-left: none; border-top: none; }
        .scanner-line { position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent, var(--accent-color), transparent); animation: scan 2s linear infinite; }
        @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }
        .booking-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; padding: 2px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); }
        .booking-card-inner { background: white; border-radius: 14px; padding: 1.5rem; }
        .booking-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 2px solid #f0f0f0; }
        .booking-card-title { font-size: 1.25rem; font-weight: 700; color: #333; }
        .booking-card-reference { background: linear-gradient(90deg, #6366f1, #8b5cf6); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.875rem; font-weight: 600; }
        .booking-card-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem; }
        .booking-card-item { display: flex; flex-direction: column; }
        .booking-card-label { font-size: 0.75rem; color: #666; margin-bottom: 0.25rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .booking-card-value { font-size: 1rem; font-weight: 600; color: #333; }
        .booking-card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; padding-top: 1rem; border-top: 2px solid #f0f0f0; }
        .booking-card-status { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--success-color); color: white; border-radius: 8px; font-size: 0.875rem; font-weight: 600; }
        .booking-card-actions { display: flex; gap: 0.5rem; }
        .booking-card-btn { padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.875rem; font-weight: 600; transition: all 0.2s; cursor: pointer; border: none; }
        .booking-card-btn-primary { background: var(--accent-color); color: white; }
        .booking-card-btn-primary:hover { background: var(--accent-hover); }
        .booking-card-btn-secondary { background: #e5e7eb; color: #333; }
        .booking-card-btn-secondary:hover { background: #d1d5db; }
        .booking-card-btn-success { background: var(--success-color); color: white; }
        .booking-card-btn-success:hover { background: #059669; }
        #video-container { position: relative; width: 100%; max-width: 400px; margin: 0 auto; aspect-ratio: 1; background: #000; border-radius: 12px; overflow: hidden; }
        #video { width: 100%; height: 100%; object-fit: cover; }
        #scan-region { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 250px; height: 250px; border: 2px solid var(--accent-color); border-radius: 12px; }
        .scan-animation { position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent, var(--accent-color), transparent); animation: scan 2s linear infinite; }
        .clock-picker { position: relative; width: 260px; height: 260px; margin: 1rem auto; }
        .clock-face { width: 100%; height: 100%; border: 2px solid var(--border-color); border-radius: 50%; }
        .clock-center { position: absolute; top: 50%; left: 50%; width: 8px; height: 8px; background: var(--accent-color); border-radius: 50%; transform: translate(-50%, -50%); }
        .clock-number { position: absolute; width: 36px; height: 36px; display: flex; justify-content: center; align-items: center; border-radius: 50%; cursor: pointer; transition: background-color 0.2s; font-size: 1rem; }
        .clock-number:hover { background-color: var(--hover-bg); }
        .clock-number.selected { background-color: var(--accent-color); color: white; }
        .clock-number.disabled { color: #cbd5e1; cursor: not-allowed; pointer-events: none; background: transparent !important; }
        .booking-details { background-color: #f8fafc; border-left: 4px solid var(--accent-color); }
        .booking-details h4 { color: var(--accent-color); }
        .booking-details-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .detail-item { display: flex; flex-direction: column; }
        .detail-label { font-size: 0.875rem; color: #64748b; margin-bottom: 0.25rem; }
        .detail-value { font-weight: 500; }
        .time-conflict { background-color: #fef2f2; border: 1px solid #fecaca; color: #dc2626; }
        .time-conflict-warning { background-color: #fef3c7; border: 1px solid #fde68a; color: #d97706; }
        .booking-readonly { background-color: #f9fafb; border: 1px solid #e5e7eb; }
        .booking-readonly input, .booking-readonly textarea { background-color: #f3f4f6; color: #6b7280; cursor: not-allowed; }
        .hero-section { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem 0; margin-bottom: 2rem; }
        .hero-title { font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem; }
        .hero-subtitle { font-size: 1.125rem; opacity: 0.9; }
        .manual-section { background-color: #f0f9ff; border: 1px solid #bae6fd; border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem; }
        .manual-title { font-size: 1.25rem; font-weight: 600; color: #0369a1; margin-bottom: 0.5rem; }
        .manual-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .manual-content.expanded { max-height: 2000px; transition: max-height 0.5s ease-in; }
        .manual-step { margin-bottom: 1rem; padding-left: 1.5rem; position: relative; }
        .manual-step:before { content: counter(step-counter); counter-increment: step-counter; position: absolute; left: 0; top: 0; width: 1.5rem; height: 1.5rem; background-color: #0369a1; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold; }
        .manual-steps { counter-reset: step-counter; }
        .weekend-day { background-color: #fee2e2 !important; color: #991b1b !important; }
        .weekend-label { font-size: 0.7rem; color: #991b1b; margin-top: auto; font-weight: bold; }
        .status-badge { display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .status-pending { background-color: #fef3c7; color: #92400e; }
        .status-confirmed { background-color: #d1fae5; color: #065f46; }
        .status-completed { background-color: #dbeafe; color: #1e40af; }
        .status-late { background-color: #fee2e2; color: #991b1b; }
        .status-cancelled { background-color: #f3f4f6; color: #6b7280; }
        .check-in-section { background-color: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 1rem; margin-top: 1rem; }
        .check-in-time { font-family: 'Courier New', monospace; font-size: 1.125rem; font-weight: bold; color: #059669; }
        .attendance-stats { display: grid; grid-cols:1 md:grid-cols-3 gap-4 margin-bottom: 1rem; }
        .stat-card { background-color: white; border-radius: 8px; padding: 1rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); }
        .stat-value { font-size: 2rem; font-weight: bold; margin-bottom: 0.25rem; }
        .stat-label { font-size: 0.875rem; color: #64748b; }
        .stat-on-time { color: #059669; }
        .stat-late { color: #dc2626; }
        .stat-total { color: #6366f1; }
        .important-note { color: #dc2626; font-weight: 600; }
        .manual-important { background-color: #fef2f2; border-left: 4px solid #dc2626; padding: 0.5rem 1rem; margin: 0.5rem 0; border-radius: 0 4px 4px 0; }
        .manual-important p { margin: 0; color: #991b1b; }
        @media (max-width: 768px) {
            .hero-title { font-size: 2rem; }
            .hero-subtitle { font-size: 1rem; }
            .booking-card-grid { grid-template-columns: 1fr; }
            .booking-card-footer { flex-direction: column; gap: 1rem; align-items: stretch; }
            .booking-card-actions { justify-content: center; }
            .staff-nav-btn { padding: 8px 12px; font-size: 14px; }
            .icon { width: 1rem; height: 1rem; }
        }
        @media (max-width: 640px) {
            .container { padding-left: 1rem; padding-right: 1rem; }
            .calendar-day { min-height: 60px; font-size: 14px; }
            .modal-backdrop .card { margin: 1rem; max-width: calc(100% - 2rem); }
        }
        .floating-scan-btn { position: fixed; bottom: 2rem; right: 2rem; width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2); cursor: pointer; transition: all 0.3s; z-index: 40; }
        .floating-scan-btn:hover { transform: scale(1.1); box-shadow: 0 6px 25px rgba(0, 0, 0, 0.3); }
        @media (max-width: 768px) {
            .floating-scan-btn { bottom: 1rem; right: 1rem; width: 50px; height: 50px; }
        }
        .kpi-company-details { margin-top: 1rem; }
        .kpi-booking-item { padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 0.5rem; background-color: #f8fafc; border-left: 3px solid var(--accent-color); }
        .kpi-booking-date { font-weight: 600; color: var(--accent-color); }
        .kpi-booking-details { display: flex; justify-content: space-between; font-size: 0.875rem; }
        .kpi-booking-score { font-weight: 600; }
        .kpi-score-high { color: var(--success-color); }
        .kpi-score-medium { color: var(--warning-color); }
        .kpi-score-low { color: var(--error-color); }
        
        /* Chat Styles */
        .chat-container { display: flex; flex-direction: column; height: 500px; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 1rem; background-color: var(--chat-bg); border-radius: 8px; }
        .chat-message { margin-bottom: 1rem; display: flex; }
        .chat-message.sent { justify-content: flex-end; }
        .chat-message.received { justify-content: flex-start; }
        .message-bubble { max-width: 70%; padding: 0.75rem 1rem; border-radius: 18px; word-wrap: break-word; }
        .message-bubble.sent { background-color: var(--chat-sent); color: #1e40af; border-bottom-right-radius: 4px; }
        .message-bubble.received { background-color: var(--chat-received); color: #4338ca; border-bottom-left-radius: 4px; }
        .message-time { font-size: 0.75rem; color: #64748b; margin-top: 0.25rem; }
        .chat-input-container { display: flex; gap: 0.5rem; margin-top: 1rem; }
        .chat-input { flex: 1; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 24px; }
        .chat-send-btn { width: 48px; height: 48px; border-radius: 50%; background-color: var(--accent-color); color: white; display: flex; align-items: center; justify-content: center; }
        .chat-sidebar { width: 300px; border-right: 1px solid var(--border-color); }
        .chat-list { height: 500px; overflow-y: auto; }
        .chat-item { padding: 1rem; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background-color 0.2s; }
        .chat-item:hover { background-color: var(--hover-bg); }
        .chat-item.active { background-color: var(--accent-color); color: white; }
        .chat-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .chat-item-name { font-weight: 600; }
        .chat-item-time { font-size: 0.75rem; color: #64748b; }
        .chat-item-preview { font-size: 0.875rem; color: #64748b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .notification-badge { background-color: var(--error-color); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; }
        
        /* User Management Styles */
        .user-table { width: 100%; border-collapse: collapse; }
        .user-table th, .user-table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border-color); }
        .user-table th { background-color: #f8fafc; font-weight: 600; }
        .user-table tr:hover { background-color: var(--hover-bg); }
        .role-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .role-admin { background-color: #fef3c7; color: #92400e; }
        .role-staff { background-color: #dbeafe; color: #1e40af; }
        .role-viewer { background-color: #e0e7ff; color: #4338ca; }
        
        /* Notification Styles */
        .notification-item { padding: 1rem; border-bottom: 1px solid var(--border-color); }
        .notification-item.unread { background-color: #f0f9ff; }
        .notification-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .notification-title { font-weight: 600; }
        .notification-time { font-size: 0.75rem; color: #64748b; }
        .notification-content { font-size: 0.875rem; color: #64748b; }
        .notification-type { display: inline-block; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; margin-right: 0.5rem; }
        .notification-reminder { background-color: #fef3c7; color: #92400e; }
        .notification-arrival { background-color: #dbeafe; color: #1e40af; }
        .notification-message { background-color: #e0e7ff; color: #4338ca; }
        
        /* Animation for new messages */
        @keyframes messageSlideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chat-message.new-message {
            animation: messageSlideIn 0.3s ease-out;
        }
        
        /* Typing indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 8px 12px;
            background-color: #e0e7ff;
            border-radius: 18px;
            width: fit-content;
        }
        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: #6366f1;
            border-radius: 50%;
            animation: typingAnimation 1.4s infinite;
        }
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes typingAnimation {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
    </style>
</head>
<body>
    <div id="app-container" class="container mx-auto px-4 md:px-6 lg:px-8 py-4 md:py-6 lg:py-8"></div>
    <div id="modal-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, collection, query, orderBy, limit, getDocs, addDoc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBezNic5rqHg2xh9_9dHo5DUDoHZx1Z_v8",
          authDomain: "schedule-a-delivery.firebaseapp.com",
          projectId: "schedule-a-delivery",
          storageBucket: "schedule-a-delivery.appspot.com",
          messagingSenderId: "222743116863",
          appId: "1:222743116863:web:12df3ee05d2894f23ccc8a",
          measurementId: "G-EDV364EREE"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const docRef = doc(db, "schedules", "main");
        const GEMINI_API_KEY = "AIzaSyD_d2g0XgVxkClULTmh6dfl_eKIkRuVo7E";

        let state = {
            isLoggedIn: false, 
            userRole: 'guest', 
            currentView: 'calendar',
            currentDate: new Date(), 
            selectedDate: null, 
            selectedBookingId: null,
            guestBookingIds: [], 
            data: { bookings: {}, companies: [], holidays: [], users: [], chats: [], notifications: [] },
            kpiSearchTerm: '', 
            selectedKpiCompany: null,
            currentUser: null,
            activeChat: null,
            unreadNotifications: 0,
            typingUsers: new Set(),
            lastSeenMessages: new Map()
        };
        
        const icons = {
            dashboard: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>`,
            calendar: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>`,
            kpi: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>`,
            queue: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>`,
            company: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>`,
            booking: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>`,
            scanner: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path></svg>`,
            manual: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>`,
            check: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
            clock: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
            chat: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>`,
            users: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>`,
            notifications: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>`
        };

        const kpiDefinitions = [{ id: 'productQuality', label: 'คุณภาพสินค้า/บริการ' }, { id: 'onTimeDelivery', label: 'การจัดส่งตรงเวลา' }, { id: 'documentAccuracy', label: 'ความถูกต้องของเอกสาร' }, { id: 'compliance', label: 'การปฏิบัติตามข้อตกลง' }];
        
        const appContainer = document.getElementById('app-container');
        const modalContainer = document.getElementById('modal-container');
        
        const initialCompanies = ["Yokohama Thai sale ประเทศไทยจำกัด", "บริษัทโตชิโนซัพพลายจำกัด", "กิม แม็กซ์", "คิมเบอร์ลี่ย์", "เคเอสโกลเด้น", "บริษัทแคบริคไทยแลนด์จำกัด", "หจก.จันทร์ประไพภัทรอินดัสตรี", "จีระวัฒนา", "ชินเตอโปรดัดจำกัด", "โชลุชั่น", "เซ้าซิตีโพลีเคมจำกัด", "ณภัทร​โปรดักส์", "เด็นโซ่​เซลล์​", "ต.สยามคอมเมอร์เชียล", "โตโยไทร์", "ทีเอสที อินเตอร์ โปรดักส์", "ทีโอเอ", "บริษัท ไทยเคเคอุตสาหกรรม จำกัด", "ไทยนาโต้แพคกิ้งเทป", "ไทยหัวเว่ย", "นณภางค์อินเตอร์เทรด", "บจก.ณภัทร​โปรดักส์", "บจก.เอดีบี ซีแลนท์", "บจ.สยามคีนิคเชลส์", "บริษัท จีกูู๊ด จำกัด", "บริษัท บางกอกแอ๊บเบอร์ซีฟ จำกัด", "บริษัท สยามคีนิค เซลส์ จำกัด", "บริษัท อัลติเมท พลัส ซัพพลาย", "บริษัท อัสซ่า อัลลอย", "บริษัท โออีเอ็ม แอ๊บเบรชีฟ โปรดักส์ จำกัด", "บจก ประมาณและบุตรจำกัด", "บจก ผลธัญญะจำกัด", "พี.ดี.เอส", "พี.เอ.พี", "มโนยนต์ชัย", "รวงข้าว 168 กรุ๊ป (ประเทศไทย)", "วรากุล", "ศรีอุดมสรรพ์", "สมาร์ท ปริ้นท์ แฟบริค จำกัด", "สยามวาลา", "เอฟเอ็มพีดิสทริบิวชั่น", "เอ็น.ดี รับเบอร์ จำกัด มหาชน", "FUCHS", "IPA", "MNI", "NCR", "SMTV", "บริษัท ยัวซ่าแบตเตอรี่ ประเทศไทย จำกัด (มหาชน)", "บริษัท มายสกาย จำกัด"];

        const formatDate = (date) => {
            if (!(date instanceof Date)) {
                date = new Date(date);
            }
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        
        const formatThaiDate = (dateStr) => new Date(dateStr).toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
        const formatTime24h = (timeStr) => {
            if (!timeStr) return '';
            const [hour, minute] = timeStr.split(':');
            return `${hour.padStart(2, '0')}:${minute.padStart(2, '0')}`;
        }

        const formatDateTime = (date) => {
            if (!date) return '';
            const d = new Date(date);
            return `${formatDate(d)} ${formatTime24h(`${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`)}`;
        };

        const generateReferenceNumber = () => {
            const date = new Date();
            const year = date.getFullYear().toString().slice(-2);
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            return `QR${year}${month}${day}${random}`;
        };

        const handleFileUpload = (fileInput) => {
            const files = fileInput.files;
            const filePromises = [];
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();
                
                const filePromise = new Promise((resolve) => {
                    reader.onload = (e) => {
                        resolve({
                            name: file.name,
                            type: file.type,
                            size: file.size,
                            data: e.target.result
                        });
                    };
                    reader.readAsDataURL(file);
                });
                
                filePromises.push(filePromise);
            }
            
            return Promise.all(filePromises);
        };

        const formatFileSize = (bytes) => {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        };

        const generateQRCode = (data, container) => {
            const canvas = document.createElement('canvas');
            canvas.width = 200;
            canvas.height = 200;
            const ctx = canvas.getContext('2d');
            
            loadQRCodeLibrary().then(QRCode => {
                try {
                    QRCode.toCanvas(canvas, data, {
                        width: 200,
                        margin: 2,
                        color: { dark: '#000000', light: '#FFFFFF' }
                    }, function (error) {
                        if (error) {
                            console.error('Error generating QR Code:', error);
                            showQRCodeError(container, data);
                        } else {
                            container.innerHTML = '';
                            container.appendChild(canvas);
                        }
                    });
                } catch (error) {
                    console.error('Error using QRCode library:', error);
                    showQRCodeError(container, data);
                }
            }).catch(error => {
                console.error('Error loading QRCode library:', error);
                showQRCodeError(container, data);
            });
        };

        const showQRCodeError = (container, data) => {
            const parsedData = JSON.parse(data);
            container.innerHTML = `
                <div class="text-center p-4">
                    <svg class="w-16 h-16 mx-auto text-red-500 mb-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    <p class="text-red-500 font-bold">ไม่สามารถสร้าง QR Code ได้</p>
                    <p class="text-sm text-gray-600 mt-2">กรุณาบันทึกข้อมูลการจองคิว</p>
                    <div class="mt-4 p-3 bg-gray-100 rounded text-left">
                        <p class="text-sm"><strong>รหัสจอง:</strong> ${parsedData.id}</p>
                        <p class="text-sm"><strong>เลขกำกับ:</strong> ${parsedData.referenceNumber}</p>
                        <p class="text-sm"><strong>บริษัท:</strong> ${parsedData.company}</p>
                        <p class="text-sm"><strong>วันที่:</strong> ${parsedData.date}</p>
                        <p class="text-sm"><strong>เวลา:</strong> ${parsedData.time}</p>
                    </div>
                </div>
            `;
        };

        const loadQRCodeLibrary = () => {
            return new Promise((resolve, reject) => {
                if (window.QRCode) {
                    resolve(window.QRCode);
                    return;
                }
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js';
                script.onload = () => {
                    if (window.QRCode) {
                        resolve(window.QRCode);
                    } else {
                        reject(new Error('QRCode library loaded but not available'));
                    }
                };
                script.onerror = () => {
                    reject(new Error('Failed to load QRCode library'));
                };
                document.head.appendChild(script);
            });
        };

        const downloadQRCode = () => {
            const canvas = document.querySelector('#qrcode-container canvas');
            if (canvas) {
                const link = document.createElement('a');
                link.download = `qrcode-${Date.now()}.png`;
                link.href = canvas.toDataURL();
                link.click();
            } else {
                alert('ไม่พบ QR Code ที่จะดาวน์โหลด');
            }
        };

        // แก้ไขฟังก์ชันตรวจสอบความขัดแย้งของเวลา
        const checkTimeConflict = (date, time, excludeBookingId = null) => {
            const bookings = state.data.bookings[date] || [];
            const sameTimeBookings = bookings.filter(booking => 
                booking.id !== excludeBookingId && booking.eta === time
            );
            
            // ตรวจสอบว่ามีการจองในเวลาเดียวกันแล้วกี่คิว
            return sameTimeBookings.length;
        };

        // แก้ไขฟังก์ชันคำนวณเวลาใหม่
        const calculateNewTime = (time, addMinutes = 10) => {
            const [hours, minutes] = time.split(':').map(Number);
            const totalMinutes = hours * 60 + minutes + addMinutes;
            const newHours = Math.floor(totalMinutes / 60);
            const newMinutes = totalMinutes % 60;
            return `${String(newHours).padStart(2, '0')}:${String(newMinutes).padStart(2, '0')}`;
        };

        const checkDailyQueueLimit = (date) => {
            const bookings = state.data.bookings[date] || [];
            return bookings.length >= 20;
        };

        const isHoliday = (date) => {
            if (!state.data.holidays) return false;
            
            const dateStr = formatDate(date);
            const monthDay = `${date.getMonth() + 1}-${date.getDate()}`;
            
            // Check if it's a weekend (Saturday=6, Sunday=0)
            const dayOfWeek = date.getDay();
            if (dayOfWeek === 0 || dayOfWeek === 6) {
                return { name: 'วันหยุดสุดสัปดาห์', type: 'weekend' };
            }
            
            // Check if it's a defined holiday
            const holiday = state.data.holidays.find(h => {
                if (h.date === dateStr) return true;
                if (h.recurring) {
                    const holidayDate = new Date(h.date);
                    const holidayMonthDay = `${holidayDate.getMonth() + 1}-${holidayDate.getDate()}`;
                    return holidayMonthDay === monthDay;
                }
                return false;
            });
            
            return holiday || false;
        };

        const checkIfLate = (booking) => {
            if (!booking || !booking.eta || !booking.checkInTime) return false;
            
            const bookingDateTime = new Date(`${booking.date} ${booking.eta}`);
            const checkInDateTime = new Date(booking.checkInTime);
            
            // Consider late if check-in is more than 15 minutes after scheduled time
            const diffMinutes = (checkInDateTime - bookingDateTime) / (1000 * 60);
            return diffMinutes > 15;
        };

        const getAttendanceStats = () => {
            const today = formatDate(new Date());
            const todayBookings = state.data.bookings[today] || [];
            
            let onTime = 0;
            let late = 0;
            let total = 0;
            
            todayBookings.forEach(booking => {
                if (booking.checkInTime) {
                    total++;
                    if (checkIfLate(booking)) {
                        late++;
                    } else {
                        onTime++;
                    }
                }
            });
            
            return { onTime, late, total };
        };

        // ฟังก์ชันสำหรับระบบแจ้งเตือน
        const createNotification = (type, title, content, userId = null, bookingId = null) => {
            const notification = {
                id: Date.now(),
                type,
                title,
                content,
                userId,
                bookingId,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            if (!state.data.notifications) {
                state.data.notifications = [];
            }
            
            state.data.notifications.push(notification);
            
            // อัปเดตจำนวนการแจ้งเตือนที่ยังไม่ได้อ่าน
            if (!userId || userId === state.currentUser?.id) {
                state.unreadNotifications++;
            }
            
            // บันทึกข้อมูล
            setDoc(docRef, state.data);
            
            // แสดงการแจ้งเตือนในเบราว์เซอร์
            if (Notification.permission === 'granted' && (!userId || userId === state.currentUser?.id)) {
                new Notification(title, {
                    body: content,
                    icon: '/favicon.ico'
                });
            }
            
            return notification;
        };

        // ฟังก์ชันสำหรับส่งข้อความในแชท
        const sendMessage = async (chatId, senderId, message) => {
            if (!state.data.chats) {
                state.data.chats = [];
            }
            
            // ค้นหาแชทที่มีอยู่
            let chat = state.data.chats.find(c => c.id === chatId);
            
            if (!chat) {
                // สร้างแชทใหม่ถ้าไม่พบ
                chat = {
                    id: chatId,
                    participants: [senderId],
                    messages: [],
                    lastUpdated: new Date().toISOString()
                };
                state.data.chats.push(chat);
            }
            
            // เพิ่มข้อความใหม่
            const newMessage = {
                id: Date.now(),
                senderId,
                content: message,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            chat.messages.push(newMessage);
            chat.lastUpdated = new Date().toISOString();
            
            // สร้างการแจ้งเตือนสำหรับผู้รับ
            const otherParticipants = chat.participants.filter(p => p !== senderId);
            otherParticipants.forEach(participantId => {
                const participant = state.data.users.find(u => u.id === participantId);
                if (participant) {
                    createNotification(
                        'message',
                        `ข้อความใหม่จาก ${state.currentUser?.name || 'พนักงาน'}`,
                        message,
                        participantId
                    );
                }
            });
            
            // บันทึกข้อมูล
            await setDoc(docRef, state.data);
            
            return newMessage;
        };

        // ฟังก์ชันสำหรับตั้งค่าการแจ้งเตือนอัตโนมัติ
        const setupAutomaticNotifications = () => {
            // ตรวจสอบการจองที่จะถึงในอีก 1 ชั่วโมง
            const checkUpcomingBookings = () => {
                const now = new Date();
                const oneHourLater = new Date(now.getTime() + 60 * 60 * 1000);
                
                Object.entries(state.data.bookings).forEach(([date, bookings]) => {
                    bookings.forEach(booking => {
                        const bookingDateTime = new Date(`${date} ${booking.eta}`);
                        
                        // ตรวจสอบว่าการจองจะถึงในอีก 1 ชั่วโมงและยังไม่ได้เช็คอิน
                        if (bookingDateTime > now && bookingDateTime <= oneHourLater && !booking.checkInTime) {
                            // ตรวจสอบว่ามีการแจ้งเตือนนี้แล้วหรือไม่
                            const existingNotification = state.data.notifications?.find(n => 
                                n.type === 'reminder' && 
                                n.bookingId === booking.id && 
                                n.timestamp > new Date(now.getTime() - 60 * 60 * 1000).toISOString()
                            );
                            
                            if (!existingNotification) {
                                createNotification(
                                    'reminder',
                                    'แจ้งเตือนการจองคิว',
                                    `คิวของคุณกำลังจะถึงในอีก 1 ชั่วโมง (${formatThaiDate(date)} ${formatTime24h(booking.eta)})`,
                                    null,
                                    booking.id
                                );
                            }
                        }
                    });
                });
            };
            
            // ตรวจสอบทุก 15 นาที
            setInterval(checkUpcomingBookings, 15 * 60 * 1000);
            
            // ตรวจสอบทันทีเมื่อโหลดหน้า
            checkUpcomingBookings();
        };

        // ฟังก์ชันสำหรับขอสิทธิ์การแจ้งเตือน
        const requestNotificationPermission = () => {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        console.log('Notification permission granted');
                    }
                });
            }
        };

        // ฟังก์ชันสำหรับการอัปเดตแชทแบบเรียลไทม์
        const setupRealtimeChat = () => {
            // สร้าง reference สำหรับ collection ของแชท
            const chatsCollection = collection(db, "chats");
            
            // ฟังการเปลี่ยนแปลงใน collection ของแชท
            onSnapshot(chatsCollection, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "modified") {
                        const chatData = change.doc.data();
                        const chatId = change.doc.id;
                        
                        // อัปเดตข้อมูลแชทใน state
                        const chatIndex = state.data.chats.findIndex(c => c.id === chatId);
                        if (chatIndex !== -1) {
                            state.data.chats[chatIndex] = { ...chatData, id: chatId };
                            
                            // ถ้าเป็นแชทที่กำลังเปิดอยู่ ให้อัปเดต UI
                            if (state.activeChat === chatId) {
                                renderChatMessages();
                            }
                            
                            // ถ้ามีข้อความใหม่และไม่ได้เปิดแชทนี้อยู่ ให้แสดงการแจ้งเตือน
                            const lastMessage = chatData.messages[chatData.messages.length - 1];
                            if (lastMessage && lastMessage.senderId !== state.currentUser?.id && state.activeChat !== chatId) {
                                // อัปเดตจำนวนการแจ้งเตือน
                                updateUnreadNotifications();
                                
                                // แสดงการแจ้งเตือนในเบราว์เซอร์
                                if (Notification.permission === 'granted') {
                                    const otherParticipantId = chatData.participants.find(p => p !== state.currentUser?.id);
                                    const otherParticipant = state.data.users.find(u => u.id === otherParticipantId);
                                    const participantName = otherParticipant ? otherParticipant.name : 'ผู้ใช้';
                                    
                                    new Notification(`ข้อความใหม่จาก ${participantName}`, {
                                        body: lastMessage.content,
                                        icon: '/favicon.ico',
                                        tag: chatId
                                    });
                                }
                            }
                        }
                    } else if (change.type === "added") {
                        const chatData = change.doc.data();
                        const chatId = change.doc.id;
                        
                        // เพิ่มแชทใหม่ใน state
                        if (!state.data.chats) {
                            state.data.chats = [];
                        }
                        
                        // ตรวจสอบว่าแชทนี้มีอยู่แล้วหรือไม่
                        const existingChat = state.data.chats.find(c => c.id === chatId);
                        if (!existingChat) {
                            state.data.chats.push({ ...chatData, id: chatId });
                            
                            // ถ้าอยู่ในหน้าแชท ให้อัปเดตรายการแชท
                            if (state.currentView === 'chat') {
                                renderChatList();
                            }
                        }
                    }
                });
            });
        };

        // แยกฟังก์ชันสำหรับการแสดงผลข้อความในแชท
        const renderChatMessages = () => {
            const activeChat = state.data.chats.find(c => c.id === state.activeChat);
            if (!activeChat) return;
            
            const chatMessagesContainer = document.querySelector('.chat-messages');
            if (!chatMessagesContainer) return;
            
            // สร้าง HTML สำหรับข้อความในแชท
            const chatMessagesHtml = activeChat.messages.map((message, index) => {
                const isSent = message.senderId === state.currentUser?.id;
                const sender = state.data.users.find(u => u.id === message.senderId);
                const senderName = sender ? sender.name : message.senderId || 'ไม่ทราบชื่อ';
                
                // เพิ่ม class สำหรับ animation ถ้าเป็นข้อความใหม่
                const isNewMessage = index === activeChat.messages.length - 1 && 
                                   state.lastSeenMessages.get(state.activeChat) !== message.id;
                
                return `
                <div class="chat-message ${isSent ? 'sent' : 'received'} ${isNewMessage ? 'new-message' : ''}">
                    <div class="message-bubble">
                        <div>${message.content}</div>
                        <div class="message-time">${formatTime24h(new Date(message.timestamp).toLocaleTimeString())}</div>
                    </div>
                </div>
                `;
            }).join('');
            
            chatMessagesContainer.innerHTML = chatMessagesHtml;
            
            // บันทึกข้อความล่าสุดที่เห็น
            if (activeChat.messages.length > 0) {
                state.lastSeenMessages.set(state.activeChat, activeChat.messages[activeChat.messages.length - 1].id);
            }
            
            // เลื่อนไปที่ข้อความล่าสุด
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        };

        // แยกฟังก์ชันสำหรับการแสดงผลรายการแชท
        const renderChatList = () => {
            const chats = state.data.chats || [];
            const chatListContainer = document.querySelector('.chat-list');
            if (!chatListContainer) return;
            
            // สร้าง HTML สำหรับรายการแชท
            const chatListHtml = chats.map(chat => {
                // หาข้อความล่าสุด
                const lastMessage = chat.messages.length > 0 ? chat.messages[chat.messages.length - 1] : null;
                
                // หาชื่อผู้ใช้อื่นในแชท
                const otherParticipantId = chat.participants.find(p => p !== state.currentUser?.id);
                const otherParticipant = state.data.users.find(u => u.id === otherParticipantId);
                const participantName = otherParticipant ? otherParticipant.name : otherParticipantId || 'ไม่ทราบชื่อ';
                
                // ตรวจสอบว่ามีข้อความที่ยังไม่ได้อ่านหรือไม่
                const unreadCount = chat.messages.filter(m => 
                    m.senderId !== state.currentUser?.id && 
                    !m.read
                ).length;
                
                // แสดงข้อมูลคิวที่เกี่ยวข้องถ้ามี
                let bookingInfo = '';
                if (chat.bookingId) {
                    const booking = findBookingById(chat.bookingId);
                    if (booking) {
                        bookingInfo = `
                            <div class="text-xs text-gray-500 mt-1">
                                คิว: ${booking.referenceNumber} | ${formatThaiDate(booking.date)} ${formatTime24h(booking.eta)}
                            </div>
                        `;
                    }
                }
                
                return `
                <div class="chat-item ${state.activeChat === chat.id ? 'active' : ''}" data-chat-id="${chat.id}">
                    <div class="chat-item-header">
                        <div class="chat-item-name">${participantName}</div>
                        <div class="chat-item-time">${lastMessage ? formatTime24h(new Date(lastMessage.timestamp).toLocaleTimeString()) : ''}</div>
                    </div>
                    <div class="chat-item-preview">${lastMessage ? lastMessage.content : 'ยังไม่มีข้อความ'}</div>
                    ${bookingInfo}
                    ${unreadCount > 0 ? `<div class="notification-badge">${unreadCount}</div>` : ''}
                </div>
                `;
            }).join('');
            
            chatListContainer.innerHTML = chatListHtml || '<div class="p-4 text-center text-gray-500">ไม่มีแชท</div>';
            
            // เพิ่ม event listeners สำหรับรายการแชท
            document.querySelectorAll('.chat-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    const chatId = e.currentTarget.dataset.chatId;
                    state.activeChat = chatId;
                    
                    // ทำเครื่องหมายว่าอ่านแล้วทั้งหมดในแชทนี้
                    const chat = state.data.chats.find(c => c.id === chatId);
                    if (chat) {
                        chat.messages.forEach(message => {
                            if (message.senderId !== state.currentUser?.id) {
                                message.read = true;
                            }
                        });
                        
                        // บันทึกข้อมูล
                        setDoc(docRef, state.data);
                        
                        // อัปเดตจำนวนการแจ้งเตือนที่ยังไม่ได้อ่าน
                        updateUnreadNotifications();
                    }
                    
                    render();
                });
            });
        };

        // ฟังก์ชันสำหรับแสดงตัวบ่งชี้การพิมพ์
        const showTypingIndicator = (userId) => {
            const chatMessagesContainer = document.querySelector('.chat-messages');
            if (!chatMessagesContainer) return;
            
            const user = state.data.users.find(u => u.id === userId);
            const userName = user ? user.name : 'ผู้ใช้';
            
            const typingHtml = `
                <div class="chat-message received typing-indicator-container">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            
            // ตรวจสอบว่ามีตัวบ่งชี้การพิมพ์อยู่แล้วหรือไม่
            const existingIndicator = chatMessagesContainer.querySelector('.typing-indicator-container');
            if (!existingIndicator) {
                chatMessagesContainer.insertAdjacentHTML('beforeend', typingHtml);
                chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
            }
        };

        // ฟังก์ชันสำหรับซ่อนตัวบ่งชี้การพิมพ์
        const hideTypingIndicator = () => {
            const typingIndicator = document.querySelector('.typing-indicator-container');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        };

        const renderModalBase = (content, attachListenersCallback) => {
            const modalHtml = `<div class="modal-backdrop fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center p-4 z-50 fade-in"><div class="card bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl text-left max-h-[90vh] overflow-y-auto">${content}</div></div>`;
            modalContainer.insertAdjacentHTML('beforeend', modalHtml);
            const modal = modalContainer.lastElementChild;
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal-backdrop')) {
                        closeModal(modal);
                    }
                });
                modal.querySelector('.close-modal-btn')?.addEventListener('click', () => closeModal(modal));
                modal.querySelector('#download-qr-btn')?.addEventListener('click', downloadQRCode);
                if (attachListenersCallback) attachListenersCallback(modal);
            }
        };

        const closeModal = (modalElement) => {
            const modalToClose = modalElement || modalContainer.lastElementChild;
            if (modalToClose) {
                modalToClose.remove();
            }
        };
        
        const showAlert = (message) => {
            const modalContent = `
                <p class="text-lg mb-4">${message}</p>
                <button class="close-modal-btn btn btn-primary w-full">ตกลง</button>
            `;
            renderModalBase(modalContent);
        };

        const showConfirm = (message, onConfirm) => {
            const modalContent = `
                <p class="text-lg mb-6">${message}</p>
                <div class="flex justify-center gap-4">
                    <button class="close-modal-btn btn btn-secondary">ยกเลิก</button>
                    <button id="confirm-ok" class="btn btn-danger">ยืนยัน</button>
                </div>
            `;
            renderModalBase(modalContent, modal => {
                modal.querySelector('#confirm-ok').addEventListener('click', () => {
                    onConfirm();
                    closeModal(modal);
                });
            });
        };

        const showSuccessAnimation = (message, onComplete) => {
            const modalContent = `
                <svg class="success-checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                    <circle class="success-checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
                    <path class="success-checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                </svg>
                <h3 class="text-xl font-bold mt-4" style="color: var(--success-color);">${message}</h3>`;
            renderModalBase(modalContent);
            setTimeout(() => {
                closeModal();
                if (onComplete) onComplete();
            }, 1800);
        };
        
        const render = () => {
            const header = `
                <header class="hero-section">
                    <div class="container mx-auto px-4">
                        <div class="flex flex-col md:flex-row justify-between items-center">
                            <div>
                                <h1 class="hero-title">ระบบจัดการคิว</h1>
                                <p class="hero-subtitle">${state.userRole === 'staff' ? 'มุมมองพนักงาน' : 'สำหรับซัพพลายเออร์'}</p>
                            </div>
                            <div class="flex items-center gap-3 mt-4 md:mt-0">
                                ${state.isLoggedIn ? `<button id="logout-btn" class="btn btn-secondary flex items-center gap-2">ออกจากระบบ</button>` : '<button id="staff-login-btn" class="btn btn-primary flex items-center gap-2">พนักงาน</button>'}
                                <button id="quick-scan-btn" class="btn btn-success flex items-center gap-2">
                                    ${icons.scanner} สแกน QR
                                </button>
                                ${state.isLoggedIn ? `
                                <button id="notifications-btn" class="btn btn-secondary flex items-center gap-2 relative">
                                    ${icons.notifications} การแจ้งเตือน
                                    ${state.unreadNotifications > 0 ? `<span class="notification-badge">${state.unreadNotifications}</span>` : ''}
                                </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </header>`;
            
            // เพิ่มฟอร์มแชทสำหรับซัพพลายเอร์
            const supplierChatSection = state.userRole === 'guest' ? `
                <div class="card p-4 rounded-xl shadow-lg mb-6 bg-blue-50 border-blue-200">
                    <h3 class="text-lg font-semibold mb-3 text-blue-800">ติดต่อพนักงานผ่านแชท</h3>
                    <p class="text-sm text-blue-700 mb-4">หากมีข้อสงสัยเกี่ยวกับการจองคิว กรุณากรอกเลขกำกับ QR เพื่อเริ่มการสนทนากับพนักงาน</p>
                    <div class="flex gap-2">
                        <input type="text" id="supplier-chat-reference" placeholder="กรอกเลขกำกับ QR (เช่น QR2401231234)" class="input flex-1">
                        <button id="start-chat-btn" class="btn btn-primary">เริ่มแชท</button>
                    </div>
                </div>
            ` : '';
            
            // Add manual section for all users
            const manualSection = `
                <div class="manual-section">
                    <div class="flex justify-between items-center">
                        <h3 class="manual-title flex items-center gap-2">
                            ${icons.manual} คู่มือการใช้งานระบบจองคิว
                        </h3>
                        <button id="toggle-manual-btn" class="btn btn-primary btn-sm">
                            <span id="manual-toggle-text">แสดง</span>
                        </button>
                    </div>
                    <div id="manual-content" class="manual-content">
                        <div class="manual-steps mt-4">
                            <div class="manual-step">
                                <h4 class="font-semibold">การเข้าสู่ระบบจัดการคิว</h4>
                                <p>เข้าใช้งานเว็บไซต์ได้ที่ borneoship.netlify.app หรือสแกน QR Code เพื่อเข้าสู่หน้าเว็บไซต์ได้ทันที</p>
                            </div>
                            <div class="manual-step">
                                <h4 class="font-semibold">การเลือกวันจัดส่งสินค้า</h4>
                                <p>เมื่อเข้าสู่ระบบแล้ว จะพบหน้าปฏิทินของ "ระบบจัดการคิว" กรุณาเลือกวันที่ต้องการเข้าส่งสินค้า โดยวันที่สามารถจองได้จะแสดงเป็นปุ่มที่กดได้</p>
                                <div class="manual-important">
                                    <p>หมายเหตุ: หากวันใดขึ้นเป็นสีแดง แสดงว่าเป็นวันหยุดของบริษัท จะไม่สามารถจองคิวส่งสินค้าในวันดังกล่าวได้</p>
                                </div>
                            </div>
                            <div class="manual-step">
                                <h4 class="font-semibold">การกรอกข้อมูลการจอง</h4>
                                <p>หลังจากเลือกวันที่แล้ว ระบบจะนำไปสู่หน้าจอที่แสดงปุ่ม "จองคิวลงสินค้า" กดปุ่มเพื่อเข้าสู่แบบฟอร์มการจอง</p>
                                <p>ในส่วนของ "บริษัท" ให้เลือกชื่อบริษัท หากไม่มีในรายการ กรุณาเลือก "-- เพิ่มบริษัทใหม่ --" เพื่อกรอกข้อมูล</p>
                                <div class="manual-important">
                                    <p>หมายเหตุ: หากเป็นการเพิ่มบริษัทใหม่กรุณาใช้ชื่อบริษัทแบบเต็มตามที่ระบุใน Invoice</p>
                                </div>
                            </div>
                            <div class="manual-step">
                                <h4 class="font-semibold">การกรอกรายละเอียด</h4>
                                <p>กรอกข้อมูลในแบบฟอร์มให้ครบถ้วน:</p>
                                <ul class="list-disc list-inside ml-4 mt-2">
                                    <li>ชื่อ-นามสกุล คนขับ: กรอกชื่อผู้ขับรถที่จะนำสินค้ามาส่ง</li>
                                    <li>ทะเบียนรถ: ระบุหมายเลขทะเบียนรถให้ถูกต้อง</li>
                                    <li>จำนวนบิล, จำนวนกล่อง, จำนวนชิ้น: กรอกข้อมูลตามความเป็นจริง โดยจำนวนชิ้นควรตรงกับข้อมูลในเอกสาร</li>
                                    <li>เวลาที่คาดว่าจะมาถึง: กดเพื่อเลือกช่วงเวลาที่คาดว่าจะเดินทางมาถึงคลังสินค้า</li>
                                </ul>
                            </div>
                            <div class="manual-step">
                                <h4 class="font-semibold">การแนบเอกสารเพิ่มเติม (ถ้ามี)</h4>
                                <p>สามารถแนบไฟล์ Invoice และ P.O. เพื่อเพิ่มความรวดเร็วในการตรวจสอบสินค้าของพนักงาน</p>
                                <p>คลิกที่ช่องสำหรับแนบไฟล์ และเลือกไฟล์จากอุปกรณ์</p>
                                <p>ไฟล์ที่รองรับ ได้แก่ PDF, JPG, PNG, DOC, และ DOCX โดยมีขนาดสูงสุดไม่เกิน 5 MB ต่อไฟล์</p>
                            </div>
                            <div class="manual-step">
                                <h4 class="font-semibold">การยืนยันการจองและรับรหัสคิว</h4>
                                <p>เมื่อกรอกข้อมูลครบถ้วนแล้ว ให้กดปุ่ม "ยืนยันการจอง"</p>
                                <div class="manual-important">
                                    <p>หมายเหตุ: หากเวลาที่เลือกมีผู้จองเต็มแล้ว ระบบจะทำการเลื่อนเวลาให้ 10 นาที โดยอัตโนมัติ</p>
                                </div>
                                <p>เมื่อการจองสำเร็จ ระบบจะแสดง QR Code และรายละเอียดการจอง</p>
                                <div class="manual-important">
                                    <p>คำแนะนำสำคัญ: กรุณาบันทึกภาพ QR Code นี้ไว้เพื่อใช้แสดงแก่พนักงานคลังสินค้าเมื่อเดินทางมาถึง</p>
                                </div>
                            </div>
                            <div class="manual-step">
                                <h4 class="font-semibold">ข้อควรทราบ</h4>
                                <ul class="list-disc list-inside ml-4 mt-2">
                                    <li>สามารถเดินทางมาถึงคลังสินค้า ก่อนเวลาที่จองไว้ได้</li>
                                    <li class="important-note">หากมาสายกว่าเวลาที่จองไว้ การจองดังกล่าวจะถือเป็นโมฆะ และจะต้องเข้าคิวแบบ Walk-in ตามปกติ</li>
                                    <li class="important-note">กรุณาหลีกเลี่ยงการจองคิวโดยที่ยังไม่มีความแน่นอนในการนำส่งสินค้าโดยเด็ดขาด เนื่องจากอาจส่งผลต่อการพิจารณาให้ความช่วยเหลือในกรณีสินค้ามีปัญหาในครั้งต่อไป</li>
                                    <li>หากมีปัญหาเพิ่มเติม กรุณาติดต่อฝ่ายการตลาดเพื่อประสานงานกับทางคลังสินค้าทันที</li>
                                </ul>
                            </div>
                            <div class="manual-step">
                                <h4 class="font-semibold">การเช็คอินเมื่อถึงคลังสินค้า</h4>
                                <p>เมื่อเดินทางมาถึงคลังสินค้า ให้แสดง QR Code ที่ได้รับจากการจองคิวให้กับพนักงานเพื่อทำการสแกน</p>
                                <p>พนักงานจะทำการสแกน QR Code และกดปุ่ม "เช็คอิน" เพื่อบันทึกเวลาที่คุณมาถึง</p>
                                <div class="manual-important">
                                    <p>คำแนะนำ: หากพนักงานกดเช็คอินแล้วไม่มีอะไรเกิดขึ้น กรุณาแจ้งพนักงานให้ลองรีเฟรชหน้าจอแล้วทำการสแกนใหม่อีกครั้ง</p>
                                </div>
                            </div>
                            <div class="manual-step">
                                <h4 class="font-semibold">การติดต่อผ่านแชท</h4>
                                <p>หากมีข้อสงสัยเกี่ยวกับการจองคิว สามารถติดต่อพนักงานผ่านระบบแชทได้โดยกรอกเลขกำกับ QR ที่ได้รับจากการจองคิว</p>
                                <p>พนักงานจะได้รับการแจ้งเตือนและทราบข้อมูลคิวของคุณทันที</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            let viewContent = '';
            switch(state.currentView) {
                case 'dashboard': viewContent = renderStaffNav() + renderDashboard(); break;
                case 'calendar': viewContent = (state.userRole === 'staff' ? renderStaffNav() : '') + supplierChatSection + manualSection + renderCalendar(); break;
                case 'holidays': viewContent = renderStaffNav() + renderHolidayManagement(); break;
                case 'dailyQueue': viewContent = renderDailyQueue(); break;
                case 'kpi': viewContent = renderStaffNav() + renderKpiView(); break;
                case 'bookingDetails': viewContent = renderBookingDetails(); break;
                case 'scanner': viewContent = renderScannerView(); break;
                case 'chat': viewContent = renderStaffNav() + renderChatView(); break;
                case 'users': viewContent = renderStaffNav() + renderUsersView(); break;
                case 'notifications': viewContent = renderStaffNav() + renderNotificationsView(); break;
            }
            
            appContainer.innerHTML = header + `<div class="fade-in">${viewContent}</div>`;
            attachAllListeners();
        };
        
        const renderStaffNav = () => `
            <div class="mb-6 bg-white p-2 rounded-lg shadow-sm">
                <div class="flex flex-wrap gap-2 justify-center md:justify-start">
                    <button data-view="dashboard" class="staff-nav-btn ${state.currentView === 'dashboard' ? 'active' : ''}">${icons.dashboard} Dashboard</button>
                    <button data-view="calendar" class="staff-nav-btn ${state.currentView === 'calendar' ? 'active' : ''}">${icons.calendar} ปฏิทิน</button>
                    <button data-view="holidays" class="staff-nav-btn ${state.currentView === 'holidays' ? 'active' : ''}">${icons.booking} วันหยุด</button>
                    <button data-view="kpi" class="staff-nav-btn ${state.currentView === 'kpi' ? 'active' : ''}">${icons.kpi} KPI</button>
                    <button data-view="bookingDetails" class="staff-nav-btn ${state.currentView === 'bookingDetails' ? 'active' : ''}">${icons.booking} รายละเอียด</button>
                    <button data-view="chat" class="staff-nav-btn ${state.currentView === 'chat' ? 'active' : ''}">${icons.chat} แชท</button>
                    <button data-view="users" class="staff-nav-btn ${state.currentView === 'users' ? 'active' : ''}">${icons.users} ผู้ใช้</button>
                    <button data-view="notifications" class="staff-nav-btn ${state.currentView === 'notifications' ? 'active' : ''}">${icons.notifications} การแจ้งเตือน</button>
                    <button data-view="scanner" class="staff-nav-btn ${state.currentView === 'scanner' ? 'active' : ''}">${icons.scanner} สแกน QR</button>
                </div>
            </div>`;
        
        const renderDashboard = () => {
            const todayStr = formatDate(new Date());
            const todayBookings = state.data.bookings[todayStr] || [];
            let next7daysBookings = 0;
            for(let i=1; i<=7; i++) { const date = new Date(); date.setDate(date.getDate() + i); next7daysBookings += (state.data.bookings[formatDate(date)] || []).length; }
            const queueItemsHtml = todayBookings.length > 0
                ? todayBookings.map(b => `<li class="flex justify-between items-center p-2 rounded hover:bg-violet-50"><span>${formatTime24h(b.eta)} - ${b.companyName}</span><span class="font-mono text-sm">${b.licensePlate}</span></li>`).join('')
                : `<p class="text-center text-slate-500 py-4">ไม่มีคิวสำหรับวันนี้</p>`;

            // Get attendance statistics
            const stats = getAttendanceStats();

            return `
            <div class="mb-4">
                ${state.userRole === 'guest' ? '<button id="back-to-calendar-btn" class="text-violet-600 hover:text-violet-800 flex items-center gap-1"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg> กลับไปยังปฏิทิน</button>' : ''}
            </div>
            
            <!-- Attendance Statistics -->
            <div class="attendance-stats mb-6">
                <div class="stat-card">
                    <div class="stat-value stat-on-time">${stats.onTime}</div>
                    <div class="stat-label">มาตรงเวลา</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value stat-late">${stats.late}</div>
                    <div class="stat-label">มาสาย</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value stat-total">${stats.total}</div>
                    <div class="stat-label">รับสินค้าแล้ว</div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
                <div class="card p-5 rounded-xl shadow-lg flex items-center gap-4 bg-violet-50 border-violet-200">
                    <div class="p-3 rounded-full bg-violet-100">${icons.queue}</div>
                    <div><h3 class="font-semibold text-violet-800">คิวสำหรับวันนี้</h3><p class="text-3xl font-bold text-violet-600">${todayBookings.length}<span class="text-base font-medium ml-1">คิว</span></p></div>
                </div>
                <div class="card p-5 rounded-xl shadow-lg flex items-center gap-4 bg-green-50 border-green-200">
                    <div class="p-3 rounded-full bg-green-100">${icons.calendar}</div>
                    <div><h3 class="font-semibold text-green-800">คิวใน 7 วันข้างหน้า</h3><p class="text-3xl font-bold text-green-600">${next7daysBookings}<span class="text-base font-medium ml-1">คิว</span></p></div>
                </div>
                <div class="card p-5 rounded-xl shadow-lg flex items-center gap-4 bg-sky-50 border-sky-200">
                    <div class="p-3 rounded-full bg-sky-100">${icons.company}</div>
                    <div><h3 class="font-semibold text-sky-800">บริษัทซัพพลายเออร์</h3><p class="text-3xl font-bold text-sky-600">${state.data.companies.length}<span class="text-base font-medium ml-1">บริษัท</span></p></div>
                </div>
            </div>
            <div class="card p-5 rounded-xl shadow-lg mt-6"><h3 class="text-xl font-semibold mb-4">รายการคิววันนี้ (${formatThaiDate(todayStr)})</h3><ul class="space-y-2">${queueItemsHtml}</ul></div>`;
        };
        
        const renderCalendar = () => {
            const date = new Date(state.currentDate);
            const month = date.getMonth();
            const year = date.getFullYear();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const monthName = date.toLocaleDateString('th-TH', { month: 'long', year: 'numeric' });
            const todayStr = formatDate(new Date());

            let myBookingsHtml = '';
            if (state.userRole === 'guest' && state.guestBookingIds.length > 0) {
                 const allMyBookings = [];
                 Object.entries(state.data.bookings).forEach(([date, bookings]) => {
                     bookings.forEach(b => {
                         if(state.guestBookingIds.includes(b.id)) {
                             allMyBookings.push({ ...b, date });
                         }
                     });
                 });
                 allMyBookings.sort((a,b) => a.date.localeCompare(b.date) || a.eta.localeCompare(b.eta));

                 if(allMyBookings.length > 0) {
                      myBookingsHtml = `<div class="card p-4 rounded-xl shadow-lg mb-6 bg-violet-50 border-violet-200"><h3 class="font-semibold text-violet-800 mb-2">สรุปคิวของฉัน</h3><ul class="space-y-1 text-sm">` +
                      allMyBookings.map(b => `<li class="text-violet-700">${new Date(b.date).toLocaleDateString('th-TH', {day: '2-digit', month: 'short'})} ${formatTime24h(b.eta)} - ${b.companyName}</li>`).join('') + `</ul></div>`;
                 }
            }
            
            let daysHtml = Array(firstDay).fill('<div class="border border-violet-100"></div>').join('');
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDateObj = new Date(year, month, day);
                const dateStr = formatDate(currentDateObj);
                const hasBookings = state.data.bookings[dateStr]?.length > 0;
                const isToday = dateStr === todayStr;
                const isFull = checkDailyQueueLimit(dateStr);
                const holiday = isHoliday(currentDateObj);
                const dayOfWeek = currentDateObj.getDay();
                
                let dayClass = 'calendar-day cursor-pointer p-2 border border-violet-100 flex flex-col rounded-md';
                let dayContent = `<span class="font-bold">${day}</span>`;
                
                // Check if it's a weekend
                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    dayClass += ' weekend-day';
                    dayContent += `<span class="weekend-label">วันหยุด</span>`;
                } else if (holiday) {
                    dayClass += ' bg-red-50 border-red-200';
                    dayContent += `<span class="text-xs text-red-600 mt-auto font-medium">${holiday.name}</span>`;
                } else if (isToday) {
                    dayClass += ' today';
                } else if (isFull) {
                    dayClass += ' bg-red-50';
                }
                
                if (hasBookings && !holiday && dayOfWeek !== 0 && dayOfWeek !== 6) {
                    dayClass += ' has-bookings';
                    
                    // Show booking times for suppliers
                    if (state.userRole === 'guest') {
                        const bookings = state.data.bookings[dateStr];
                        const myBookings = bookings.filter(b => state.guestBookingIds.includes(b.id));
                        
                        if (myBookings.length > 0) {
                            dayContent += `<span class="text-xs mt-auto font-semibold" style="color: var(--accent-color);">คิวของคุณ: ${myBookings.map(b => formatTime24h(b.eta)).join(', ')}</span>`;
                        } else {
                            dayContent += `<span class="text-xs mt-auto font-semibold" style="color: var(--accent-color);">${bookings.length} คิว</span>`;
                        }
                    } else {
                        dayContent += `<span class="text-xs mt-auto font-semibold" style="color: var(--accent-color);">${state.data.bookings[dateStr].length} คิว</span>`;
                    }
                }
                
                if (isFull && !holiday && dayOfWeek !== 0 && dayOfWeek !== 6) {
                    dayContent += '<span class="text-xs text-red-500 mt-auto">เต็ม</span>';
                }
                
                daysHtml += `<div data-date="${dateStr}" class="${dayClass}">${dayContent}</div>`;
            }

            return myBookingsHtml + `
                <main class="card p-4 md:p-5 rounded-xl shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <button id="prev-month-btn" class="p-2 rounded-full hover:bg-violet-100">&lt;</button>
                        <h2 class="text-lg md:text-xl font-semibold">${monthName}</h2>
                        <button id="next-month-btn" class="p-2 rounded-full hover:bg-violet-100">&gt;</button>
                    </div>
                    <div class="grid grid-cols-7 text-center font-semibold text-sm text-slate-500 mb-2">
                        <div class="text-red-600">อา</div><div>จ</div><div>อ</div><div>พ</div><div>พฤ</div><div>ศ</div><div class="text-red-600">ส</div>
                    </div>
                    <div class="grid grid-cols-7 gap-1">${daysHtml}</div>
                    ${state.userRole === 'staff' ? `
                    <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                            </svg>
                            <p class="text-sm text-blue-800">วันหยุด: <span class="font-medium">${(state.data.holidays || []).length}</span> วัน</p>
                        </div>
                    </div>
                    ` : ''}
                </main>`;
        };
        
        const renderDailyQueue = () => {
            const dateStr = state.selectedDate;
            const bookings = state.data.bookings[dateStr] || [];
            const isFull = checkDailyQueueLimit(dateStr);
            
            const queueItemsHtml = bookings.length > 0
                ? bookings.map((booking, index) => {
                    const isGuestBooking = state.guestBookingIds.includes(booking.id);
                    if(state.userRole === 'guest' && !isGuestBooking) return `<div class="card bg-slate-100 p-4 rounded-lg">คิวที่ ${index + 1}: จองแล้ว</div>`;
                    
                    // Determine status
                    let statusBadge = '';
                    if (booking.checkInTime) {
                        if (booking.status === 'completed') {
                            statusBadge = '<span class="status-badge status-completed">เสร็จสิ้น</span>';
                        } else if (checkIfLate(booking)) {
                            statusBadge = '<span class="status-badge status-late">มาสาย</span>';
                        } else {
                            statusBadge = '<span class="status-badge status-confirmed">เช็คอินแล้ว</span>';
                        }
                    } else {
                        statusBadge = '<span class="status-badge status-pending">รอเช็คอิน</span>';
                    }
                    
                    return `<div class="card ${isGuestBooking ? 'bg-violet-50 border-l-4 border-violet-500' : ''} p-4 rounded-lg shadow-sm">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-2">
                            <div>
                                <p class="font-bold text-lg">${booking.companyName} ${isGuestBooking ? '<span class="text-xs text-violet-600">(คิวของคุณ)</span>' : ''}</p>
                                <p class="text-sm text-slate-500">${booking.driverName} - ${booking.licensePlate}</p>
                                ${booking.referenceNumber ? `<p class="text-xs text-violet-600 font-medium">เลขกำกับ: <span class="reference-number">${booking.referenceNumber}</span></p>` : ''}
                                ${statusBadge}
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-xl text-violet-600">${formatTime24h(booking.eta)}</p>
                                <p class="text-xs text-slate-500">${booking.boxCount} กล่อง / ${booking.itemCount} ชิ้น</p>
                                ${booking.checkInTime ? `<p class="text-xs text-green-600">เช็คอิน: ${formatDateTime(booking.checkInTime)}</p>` : ''}
                            </div>
                        </div>
                        <div class="mt-2">
                            <button data-booking-id="${booking.id}" class="view-details-btn text-blue-500 text-sm hover:text-blue-700">ดูรายละเอียด</button>
                        </div>
                        ${state.userRole === 'staff' ? `
                            <div class="mt-4 border-t pt-2 flex gap-2">
                                ${!booking.checkInTime ? `<button data-booking-id="${booking.id}" class="check-in-btn btn btn-success btn-sm">เช็คอิน</button>` : ''}
                                ${booking.checkInTime && booking.status !== 'completed' ? `<button data-booking-id="${booking.id}" class="complete-btn btn btn-primary btn-sm">ยืนยันรับคิว</button>` : ''}
                                <button data-booking-id="${booking.id}" class="evaluate-btn btn btn-primary btn-sm">ประเมิน KPI</button>
                                <button data-booking-id="${booking.id}" class="chat-btn btn btn-secondary btn-sm">แชท</button>
                                <button data-booking-id="${booking.id}" class="delete-booking-btn btn btn-danger btn-sm">ลบ</button>
                            </div>
                        ` : ''}
                    </div>`;
                }).join('<div class="my-3"></div>')
                : `<p class="text-center text-slate-500 py-8">ยังไม่มีการจองคิวในวันนี้</p>`;
            
            return `
                <main>
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
                        <button id="back-to-calendar-btn" class="text-violet-600 hover:text-violet-800">&lt; กลับไป</button>
                        <h2 class="text-xl font-semibold">${formatThaiDate(dateStr)}</h2>
                        <div class="flex gap-2">
                            ${state.userRole === 'guest' && !isFull ? '<button id="book-slot-btn" class="btn btn-primary">จองคิวลงสินค้า</button>' : ''}
                            ${isFull ? '<span class="text-red-500 font-semibold">คิวเต็ม (20 คิว/วัน)</span>' : ''}
                        </div>
                    </div>
                    <div class="space-y-4">${queueItemsHtml}</div>
                </main>`;
        };

        const renderBookingDetails = () => {
            const allBookings = [];
            Object.entries(state.data.bookings).forEach(([date, bookings]) => {
                bookings.forEach(booking => {
                    allBookings.push({ ...booking, date });
                });
            });
            
            allBookings.sort((a, b) => new Date(b.date) - new Date(a.date) || b.eta.localeCompare(a.eta));
            
            const bookingsHtml = allBookings.length > 0
                ? allBookings.map(booking => {
                    // Determine status
                    let statusBadge = '';
                    if (booking.checkInTime) {
                        if (booking.status === 'completed') {
                            statusBadge = '<span class="status-badge status-completed">เสร็จสิ้น</span>';
                        } else if (checkIfLate(booking)) {
                            statusBadge = '<span class="status-badge status-late">มาสาย</span>';
                        } else {
                            statusBadge = '<span class="status-badge status-confirmed">เช็คอินแล้ว</span>';
                        }
                    } else {
                        statusBadge = '<span class="status-badge status-pending">รอเช็คอิน</span>';
                    }
                    
                    return `
                    <div class="card p-4 rounded-lg shadow-sm mb-4">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-2">
                            <div>
                                <p class="font-bold text-lg">${booking.companyName}</p>
                                <p class="text-sm text-slate-500">${booking.driverName} - ${booking.licensePlate}</p>
                                <p class="text-sm text-slate-500">${formatThaiDate(booking.date)} ${formatTime24h(booking.eta)}</p>
                                ${booking.referenceNumber ? `<p class="text-xs text-violet-600 font-medium">เลขกำกับ: <span class="reference-number">${booking.referenceNumber}</span></p>` : ''}
                                ${statusBadge}
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-slate-500">${booking.boxCount} กล่อง / ${booking.itemCount} ชิ้น</p>
                                ${booking.checkInTime ? `<p class="text-xs text-green-600">เช็คอิน: ${formatDateTime(booking.checkInTime)}</p>` : ''}
                            </div>
                        </div>
                        <div class="mt-2">
                            <button data-booking-id="${booking.id}" class="view-details-btn text-blue-500 text-sm hover:text-blue-700">ดูรายละเอียด</button>
                        </div>
                    </div>
                `}).join('')
                : `<p class="text-center text-slate-500 py-8">ยังไม่มีการจองคิว</p>`;
            
            return `
            <div class="mb-6">
                <button id="back-to-dashboard-btn" class="text-violet-600 hover:text-violet-800 flex items-center gap-1">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    กลับไปยัง Dashboard
                </button>
            </div>
            <main>
                <div class="mb-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <h2 class="text-2xl font-bold">รายละเอียดการจองคิวทั้งหมด</h2>
                    <div class="flex gap-2 w-full md:w-auto">
                        <input type="text" id="reference-search" placeholder="ค้นหาตามเลขกำกับ..." class="input flex-1 md:w-64">
                        <button id="search-reference-btn" class="btn btn-primary">ค้นหา</button>
                    </div>
                </div>
                <div class="space-y-4">${bookingsHtml}</div>
            </main>`;
        };

        const renderScannerView = () => {
            return `
            <div class="mb-4">
                <button id="back-from-scanner-btn" class="text-violet-600 hover:text-violet-800 flex items-center gap-1">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    กลับไปยังหน้าก่อนหน้า
                </button>
            </div>
            <main class="max-w-2xl mx-auto">
                <h2 class="text-2xl font-bold mb-6 text-center">สแกน QR Code</h2>
                <div class="card p-6 rounded-xl shadow-lg">
                    <div id="video-container">
                        <video id="video" autoplay playsinline></video>
                        <div id="scan-region">
                            <div class="scan-animation"></div>
                        </div>
                    </div>
                    <div class="mt-6 text-center">
                        <p class="text-slate-600 mb-4">วาง QR Code ให้อยู่ในกรอเพื่อทำการสแกน</p>
                        <div class="flex justify-center gap-2 flex-wrap">
                            <button id="start-camera-btn" class="btn btn-primary">เปิดกล้อง</button>
                            <button id="stop-camera-btn" class="btn btn-danger hidden">ปิดกล้อง</button>
                            <button id="manual-input-btn" class="btn btn-secondary">ป้อนเลขกำกับ</button>
                        </div>
                    </div>
                </div>
            </main>
            `;
        };

        const renderChatView = () => {
            // รับรายการแชททั้งหมด
            const chats = state.data.chats || [];
            
            // สร้างรายการแชทในแถบด้านข้าง
            renderChatList();
            
            // สร้างหน้าต่างแชท
            let chatMessagesHtml = '';
            let chatInputHtml = '';
            let bookingInfoHtml = '';
            
            if (state.activeChat) {
                const activeChat = chats.find(c => c.id === state.activeChat);
                
                if (activeChat) {
                    // แสดงข้อมูลคิวที่เกี่ยวข้องถ้ามี
                    if (activeChat.bookingId) {
                        const booking = findBookingById(activeChat.bookingId);
                        if (booking) {
                            bookingInfoHtml = `
                                <div class="bg-blue-50 p-3 rounded-lg mb-4">
                                    <h4 class="font-semibold text-blue-800 mb-2">ข้อมูลคิวที่เกี่ยวข้อง</h4>
                                    <div class="grid grid-cols-2 gap-2 text-sm">
                                        <div><strong>เลขกำกับ:</strong> ${booking.referenceNumber}</div>
                                        <div><strong>บริษัท:</strong> ${booking.companyName}</div>
                                        <div><strong>วันที่:</strong> ${formatThaiDate(booking.date)}</div>
                                        <div><strong>เวลา:</strong> ${formatTime24h(booking.eta)}</div>
                                    </div>
                                </div>
                            `;
                        }
                    }
                    
                    // สร้างรายการข้อความ
                    renderChatMessages();
                    
                    // สร้างช่องป้อนข้อความ
                    chatInputHtml = `
                    <div class="chat-input-container">
                        <input type="text" id="chat-message-input" class="chat-input" placeholder="พิมพ์ข้อความ...">
                        <button id="send-message-btn" class="chat-send-btn">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                            </svg>
                        </button>
                    </div>
                    `;
                }
            } else {
                chatMessagesHtml = '<div class="flex items-center justify-center h-full text-gray-500">เลือกแชทเพื่อเริ่มสนทนา</div>';
            }
            
            return `
            <div class="mb-4">
                <button id="back-to-dashboard-btn" class="text-violet-600 hover:text-violet-800 flex items-center gap-1">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    กลับไปยัง Dashboard
                </button>
            </div>
            <main class="flex gap-4">
                <div class="chat-sidebar card">
                    <h3 class="p-4 font-semibold border-b">รายการแชท</h3>
                    <div class="chat-list">
                        <!-- รายการแชทจะถูกสร้างโดย renderChatList -->
                    </div>
                </div>
                <div class="flex-1 card">
                    <div class="chat-container">
                        ${bookingInfoHtml}
                        <div class="chat-messages">
                            ${chatMessagesHtml}
                        </div>
                        ${chatInputHtml}
                    </div>
                </div>
            </main>
            `;
        };

        const renderUsersView = () => {
            const users = state.data.users || [];
            
            const usersHtml = users.map(user => {
                const roleClass = user.role === 'admin' ? 'role-admin' : 
                                 user.role === 'staff' ? 'role-staff' : 'role-viewer';
                
                return `
                <tr>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td><span class="role-badge ${roleClass}">${user.role === 'admin' ? 'ผู้ดูแลระบบ' : user.role === 'staff' ? 'พนักงาน' : 'ผู้ดู'}</span></td>
                    <td>${user.lastLogin ? formatDateTime(user.lastLogin) : 'ไม่เคยเข้าสู่ระบบ'}</td>
                    <td>
                        <button data-user-id="${user.id}" class="edit-user-btn btn btn-sm btn-secondary">แก้ไข</button>
                        <button data-user-id="${user.id}" class="delete-user-btn btn btn-sm btn-danger">ลบ</button>
                    </td>
                </tr>
                `;
            }).join('');
            
            return `
            <div class="mb-4">
                <button id="back-to-dashboard-btn" class="text-violet-600 hover:text-violet-800 flex items-center gap-1">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    กลับไปยัง Dashboard
                </button>
            </div>
            <main>
                <div class="mb-6 flex justify-between items-center">
                    <h2 class="text-2xl font-bold">จัดการผู้ใช้</h2>
                    <button id="add-user-btn" class="btn btn-primary">เพิ่มผู้ใช้</button>
                </div>
                <div class="card overflow-hidden">
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>ชื่อ</th>
                                <th>อีเมล</th>
                                <th>บทบาท</th>
                                <th>เข้าสู่ระบบครั้งล่าสุด</th>
                                <th>การจัดการ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${usersHtml || '<tr><td colspan="5" class="text-center py-4">ไม่มีผู้ใช้</td></tr>'}
                        </tbody>
                    </table>
                </div>
            </main>
            `;
        };

        const renderNotificationsView = () => {
            const notifications = state.data.notifications || [];
            
            // จัดเรียงการแจ้งเตือนตามเวลา (ล่าสุดขึ้นก่อน)
            const sortedNotifications = [...notifications].sort((a, b) => 
                new Date(b.timestamp) - new Date(a.timestamp)
            );
            
            const notificationsHtml = sortedNotifications.map(notification => {
                const typeClass = notification.type === 'reminder' ? 'notification-reminder' : 
                                 notification.type === 'arrival' ? 'notification-arrival' : 'notification-message';
                const typeLabel = notification.type === 'reminder' ? 'การแจ้งเตือน' : 
                                 notification.type === 'arrival' ? 'การมาถึง' : 'ข้อความ';
                
                return `
                <div class="notification-item ${notification.read ? '' : 'unread'}" data-notification-id="${notification.id}">
                    <div class="notification-header">
                        <div>
                            <span class="notification-type ${typeClass}">${typeLabel}</span>
                            <span class="notification-title">${notification.title}</span>
                        </div>
                        <div class="notification-time">${formatDateTime(notification.timestamp)}</div>
                    </div>
                    <div class="notification-content">${notification.content}</div>
                    ${!notification.read ? '<button class="mark-read-btn btn btn-sm btn-secondary mt-2">ทำเครื่องหมายว่าอ่านแล้ว</button>' : ''}
                </div>
                `;
            }).join('');
            
            return `
            <div class="mb-4">
                <button id="back-to-dashboard-btn" class="text-violet-600 hover:text-violet-800 flex items-center gap-1">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    กลับไปยัง Dashboard
                </button>
            </div>
            <main>
                <div class="mb-6 flex justify-between items-center">
                    <h2 class="text-2xl font-bold">การแจ้งเตือน</h2>
                    <button id="mark-all-read-btn" class="btn btn-secondary">ทำเครื่องหมายว่าอ่านทั้งหมด</button>
                </div>
                <div class="card">
                    ${notificationsHtml || '<div class="p-4 text-center text-gray-500">ไม่มีการแจ้งเตือน</div>'}
                </div>
            </main>
            `;
        };

        const getKpiData = () => {
            const companyData = {};
            Object.values(state.data.bookings).flat().forEach(b => {
                if (!b.evaluation || !b.evaluation.scores) return;
                if (!companyData[b.companyName]) {
                    companyData[b.companyName] = { 
                        scores: [], 
                        count: 0,
                        bookings: []
                    };
                }
                const evaluationScores = Object.values(b.evaluation.scores).filter(v => v > 0);
                if (evaluationScores.length === 0) return;
                const avgScore = evaluationScores.reduce((a, b) => a + b, 0) / evaluationScores.length;
                companyData[b.companyName].scores.push(avgScore);
                companyData[b.companyName].count++;
                
                // Add booking details for company history
                companyData[b.companyName].bookings.push({
                    date: b.date,
                    eta: b.eta,
                    score: avgScore,
                    driverName: b.driverName,
                    licensePlate: b.licensePlate,
                    checkInTime: b.checkInTime,
                    status: b.status
                });
            });
            
            // Sort bookings by date for each company
            Object.keys(companyData).forEach(company => {
                companyData[company].bookings.sort((a, b) => new Date(b.date) - new Date(a.date));
            });
            
            return Object.entries(companyData).map(([name, data]) => ({ 
                name, 
                averageScore: data.scores.reduce((a, b) => a + b, 0) / data.scores.length,
                bookings: data.bookings
            })).sort((a, b) => b.averageScore - a.averageScore);
        };
        
        const renderKpiView = () => {
            const kpiData = getKpiData();
            const filteredData = kpiData.filter(c => c.name.toLowerCase().includes(state.kpiSearchTerm.toLowerCase()));
            const supplierListHtml = filteredData.length > 0 ? filteredData.map((company, index) => `
                <div class="grid grid-cols-4 items-center p-3 rounded-lg hover:bg-violet-50">
                    <span class="font-bold">#${index + 1}</span>
                    <span class="col-span-2">${company.name}</span>
                    <span class="font-bold text-lg ${company.averageScore >= 4 ? 'text-green-500' : company.averageScore >= 2.5 ? 'text-yellow-500' : 'text-red-500'}">${company.averageScore.toFixed(2)}</span>
                </div>
                <div class="col-span-4">
                    <button data-company="${company.name}" class="view-company-details-btn text-blue-500 text-sm hover:text-blue-700">ดูประวัติการจัดส่ง</button>
                </div>
            `).join('') : `<p class="text-center text-slate-500 py-8">ไม่พบข้อมูลซัพพลายเออร์</p>`;

            return `
            <div class="mb-4">
                <button id="back-to-dashboard-btn" class="text-violet-600 hover:text-violet-800 flex items-center gap-1">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    กลับไปยัง Dashboard
                </button>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
                <div class="lg:col-span-2 card p-5 rounded-xl shadow-lg">
                     <h2 class="text-2xl font-bold mb-4">ผลการประเมิน KPI ซัพพลายเออร์</h2>
                     <input type="text" id="kpi-search" placeholder="ค้นหาชื่อซัพพลายเออร์..." value="${state.kpiSearchTerm}" class="input w-full mb-4">
                     <div class="grid grid-cols-4 font-semibold text-slate-500 p-3 border-b-2"><span>อันดับ</span><span class="col-span-2">ชื่อบริษัท</span><span>คะแนนเฉลี่ย</span></div>
                     <div class="space-y-2 mt-2 custom-scroll" style="max-height: 400px; overflow-y: auto;">${supplierListHtml}</div>
                </div>
                <div class="card p-5 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-4">5 อันดับคะแนนสูงสุด</h2>
                    <canvas id="kpi-chart"></canvas>
                </div>
            </div>`;
        };

        const renderHolidayManagement = () => {
            const currentYear = new Date().getFullYear();
            const holidays = state.data.holidays || [];
            
            const holidayListHtml = holidays.map((holiday, index) => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                    <div class="flex items-center gap-3">
                        <div class="w-3 h-3 rounded-full ${holiday.type === 'company' ? 'bg-blue-500' : holiday.type === 'public' ? 'bg-red-500' : 'bg-green-500'}"></div>
                        <div>
                            <p class="font-medium">${holiday.name}</p>
                            <p class="text-sm text-gray-500">${formatThaiDate(holiday.date)} ${holiday.recurring ? '(ทุกปี)' : ''}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-xs px-2 py-1 rounded-full ${
                            holiday.type === 'company' ? 'bg-blue-100 text-blue-700' : 
                            holiday.type === 'public' ? 'bg-red-100 text-red-700' : 
                            'bg-green-100 text-green-700'
                        }">
                            ${holiday.type === 'company' ? 'วันหยุดบริษัท' : 
                              holiday.type === 'public' ? 'วันหยุดราชการ' : 
                              'วันหยุดพิเศษ'}
                        </span>
                        <button type="button" onclick="deleteHoliday(${index})" class="text-red-500 hover:text-red-700">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');

            return `
            <div class="mb-6">
                <button id="back-to-dashboard-btn" class="text-violet-600 hover:text-violet-800 flex items-center gap-1">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    กลับไปยัง Dashboard
                </button>
            </div>
            <main>
                <div class="mb-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <h2 class="text-2xl font-bold">จัดการวันหยุดบริษัท</h2>
                    <div class="flex gap-2">
                        <button id="add-holiday-btn" class="btn btn-primary flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            เพิ่มวันหยุด
                        </button>
                        <button id="import-public-holidays-btn" class="btn btn-secondary flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            นำเข้าวันหยุดราชการ
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2">
                        <div class="card p-5 rounded-xl shadow-lg">
                            <h3 class="text-lg font-semibold mb-4">รายการวันหยุด (${holidays.length} วัน)</h3>
                            <div class="space-y-2 max-h-96 overflow-y-auto custom-scroll">
                                ${holidays.length > 0 ? holidayListHtml : '<p class="text-center text-gray-500 py-8">ยังไม่มีวันหยุดที่กำหนด</p>'}
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <div class="card p-5 rounded-xl shadow-lg">
                            <h3 class="text-lg font-semibold mb-4">สถิติวันหยุด</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                                    <span class="text-sm font-medium text-blue-700">วันหยุดบริษัท</span>
                                    <span class="text-lg font-bold text-blue-600">${holidays.filter(h => h.type === 'company').length}</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg">
                                    <span class="text-sm font-medium text-red-700">วันหยุดราชการ</span>
                                    <span class="text-lg font-bold text-red-600">${holidays.filter(h => h.type === 'public').length}</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                                    <span class="text-sm font-medium text-green-700">วันหยุดพิเศษ</span>
                                    <span class="text-lg font-bold text-green-600">${holidays.filter(h => h.type === 'special').length}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-5 rounded-xl shadow-lg mt-4">
                            <h3 class="text-lg font-semibold mb-4">ข้อมูลเพิ่มเติม</h3>
                            <div class="space-y-2 text-sm text-gray-600">
                                <p>• วันหยุดบริษัท: วันหยุดที่บริษัทกำหนดเอง</p>
                                <p>• วันหยุดราชการ: วันหยุดตามประกาศราชการ</p>
                                <p>• วันหยุดพิเศษ: วันหยุดกรณีพิเศษ</p>
                                <p class="mt-3 text-xs text-orange-600">⚠️ ไม่สามารถจองคิวในวันหยุดได้</p>
                                <p class="mt-3 text-xs text-red-600">⚠️ วันเสาร์และวันอาทิตย์เป็นวันหยุดสุดสัปดาห์ ไม่สามารถจองคิวได้</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>`;
        };
        
        const attachAllListeners = () => {
            document.getElementById('staff-login-btn')?.addEventListener('click', () => renderModal('login'));
            document.getElementById('logout-btn')?.addEventListener('click', handleLogout);
            document.getElementById('quick-scan-btn')?.addEventListener('click', () => {
                state.currentView = 'scanner';
                render();
            });
            document.getElementById('notifications-btn')?.addEventListener('click', () => {
                state.currentView = 'notifications';
                render();
            });
            document.querySelectorAll('.staff-nav-btn').forEach(btn => btn.addEventListener('click', e => { state.currentView = e.currentTarget.dataset.view; render(); }));
            
            // เพิ่ม event listener สำหรับปุ่มเริ่มแชท
            document.getElementById('start-chat-btn')?.addEventListener('click', () => {
                const referenceNumber = document.getElementById('supplier-chat-reference').value.trim();
                if (!referenceNumber) {
                    showAlert('กรุณากรอกเลขกำกับ QR');
                    return;
                }
                
                const booking = findBookingByReferenceNumber(referenceNumber);
                if (!booking) {
                    showAlert(`ไม่พบข้อมูลการจองคิวสำหรับเลขกำกับ: ${referenceNumber}`);
                    return;
                }
                
                const chat = openChatFromBooking(booking);
                
                // แสดงหน้าต่างแชทสำหรับซัพพลายเออร์
                renderSupplierChatView(chat, booking);
            });
            
            document.getElementById('back-to-calendar-btn')?.addEventListener('click', () => {
                state.currentView = 'calendar';
                render();
            });
            
            document.getElementById('back-to-dashboard-btn')?.addEventListener('click', () => {
                state.currentView = 'dashboard';
                render();
            });
            
            document.getElementById('back-from-scanner-btn')?.addEventListener('click', () => {
                state.currentView = state.userRole === 'staff' ? 'dashboard' : 'calendar';
                render();
            });
            
            document.getElementById('add-holiday-btn')?.addEventListener('click', () => renderAddHolidayModal());
            document.getElementById('import-public-holidays-btn')?.addEventListener('click', () => renderImportPublicHolidaysModal());
            
            // Manual toggle button
            document.getElementById('toggle-manual-btn')?.addEventListener('click', () => {
                const manualContent = document.getElementById('manual-content');
                const toggleText = document.getElementById('manual-toggle-text');
                
                if (manualContent.classList.contains('expanded')) {
                    manualContent.classList.remove('expanded');
                    toggleText.textContent = 'แสดง';
                } else {
                    manualContent.classList.add('expanded');
                    toggleText.textContent = 'ซ่อน';
                }
            });
            
            // KPI company details button
            document.querySelectorAll('.view-company-details-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const companyName = e.currentTarget.dataset.company;
                    renderCompanyKpiDetails(companyName);
                });
            });
            
            // Chat listeners
            if (state.currentView === 'chat') {
                document.getElementById('send-message-btn')?.addEventListener('click', () => {
                    const messageInput = document.getElementById('chat-message-input');
                    const message = messageInput.value.trim();
                    
                    if (message && state.activeChat) {
                        sendMessage(state.activeChat, state.currentUser?.id, message);
                        messageInput.value = '';
                        render();
                    }
                });
                
                document.getElementById('chat-message-input')?.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        const message = e.target.value.trim();
                        
                        if (message && state.activeChat) {
                            sendMessage(state.activeChat, state.currentUser?.id, message);
                            e.target.value = '';
                            render();
                        }
                    }
                });
                
                // เพิ่ม typing indicator
                document.getElementById('chat-message-input')?.addEventListener('input', (e) => {
                    const message = e.target.value.trim();
                    
                    if (message && state.activeChat) {
                        // แสดงตัวบ่งชี้การพิมพ์
                        showTypingIndicator(state.currentUser?.id);
                        
                        // ซ่อนตัวบ่งชี้หลังจากหยุดพิมพ์ 1 วินาที
                        clearTimeout(window.typingTimeout);
                        window.typingTimeout = setTimeout(() => {
                            hideTypingIndicator();
                        }, 1000);
                    }
                });
            }
            
            // Users view listeners
            if (state.currentView === 'users') {
                document.getElementById('add-user-btn')?.addEventListener('click', () => renderAddUserModal());
                
                document.querySelectorAll('.edit-user-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const userId = e.currentTarget.dataset.userId;
                        renderEditUserModal(userId);
                    });
                });
                
                document.querySelectorAll('.delete-user-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const userId = e.currentTarget.dataset.userId;
                        showConfirm('คุณต้องการลบผู้ใช้นี้ใช่หรือไม่?', () => {
                            handleDeleteUser(userId);
                        });
                    });
                });
            }
            
            // Notifications view listeners
            if (state.currentView === 'notifications') {
                document.getElementById('mark-all-read-btn')?.addEventListener('click', () => {
                    state.data.notifications.forEach(notification => {
                        notification.read = true;
                    });
                    
                    state.unreadNotifications = 0;
                    setDoc(docRef, state.data);
                    render();
                });
                
                document.querySelectorAll('.mark-read-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const notificationId = parseInt(e.currentTarget.parentElement.dataset.notificationId);
                        const notification = state.data.notifications.find(n => n.id === notificationId);
                        
                        if (notification) {
                            notification.read = true;
                            updateUnreadNotifications();
                            setDoc(docRef, state.data);
                            render();
                        }
                    });
                });
            }
            
            // Daily queue chat button
            document.querySelectorAll('.chat-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const bookingId = e.currentTarget.dataset.bookingId;
                    const booking = findBookingById(bookingId);
                    
                    if (booking) {
                        // ค้นหาแชทที่มีอยู่สำหรับบริษัทนี้
                        let chat = state.data.chats.find(c => 
                            c.participants.includes(booking.companyName)
                        );
                        
                        if (!chat) {
                            // สร้างแชทใหม่ถ้าไม่พบ
                            chat = {
                                id: Date.now().toString(),
                                participants: [booking.companyName, state.currentUser?.id],
                                messages: [],
                                lastUpdated: new Date().toISOString()
                            };
                            
                            if (!state.data.chats) {
                                state.data.chats = [];
                            }
                            
                            state.data.chats.push(chat);
                            setDoc(docRef, state.data);
                        }
                        
                        state.activeChat = chat.id;
                        state.currentView = 'chat';
                        render();
                    }
                });
            });
            
            if (state.currentView === 'calendar') attachCalendarListeners();
            else if (state.currentView === 'dailyQueue') attachDailyQueueListeners();
            else if (state.currentView === 'kpi') attachKpiListeners();
            else if (state.currentView === 'bookingDetails') attachBookingDetailsListeners();
            else if (state.currentView === 'scanner') attachScannerListeners();
        };

        // เพิ่มฟังก์ชันค้นหาคิวจากเลขกำกับ QR
        const findBookingByReferenceNumber = (referenceNumber) => {
            for (const date in state.data.bookings) {
                const booking = state.data.bookings[date].find(b => b.referenceNumber === referenceNumber);
                if (booking) {
                    return { ...booking, date };
                }
            }
            return null;
        };

        // เพิ่มฟังก์ชันสร้างหรือเปิดแชทจากข้อมูลคิว
        const openChatFromBooking = (booking) => {
            // ค้นหาแชทที่มีอยู่สำหรับบริษัทนี้
            let chat = state.data.chats.find(c => 
                c.participants.includes(booking.companyName)
            );
            
            if (!chat) {
                // สร้างแชทใหม่ถ้าไม่พบ
                chat = {
                    id: Date.now().toString(),
                    participants: [booking.companyName],
                    messages: [],
                    lastUpdated: new Date().toISOString(),
                    bookingId: booking.id,
                    bookingDate: booking.date,
                    bookingReference: booking.referenceNumber
                };
                
                if (!state.data.chats) {
                    state.data.chats = [];
                }
                
                state.data.chats.push(chat);
                setDoc(docRef, state.data);
            }
            
            // เพิ่มข้อความแรกพร้อมข้อมูลคิว
            const initialMessage = {
                id: Date.now(),
                senderId: booking.companyName,
                content: `ฉันต้องการสอบถามเกี่ยวกับคิวที่จองไว้\nเลขกำกับ: ${booking.referenceNumber}\nวันที่: ${formatThaiDate(booking.date)}\nเวลา: ${formatTime24h(booking.eta)}`,
                timestamp: new Date().toISOString(),
                isSystemMessage: true
            };
            
            chat.messages.push(initialMessage);
            chat.lastUpdated = new Date().toISOString();
            
            // สร้างการแจ้งเตือนสำหรับพนักงาน
            createNotification(
                'message',
                `ซัพพลายเออร์ติดต่อเกี่ยวกับคิว`,
                `${booking.companyName} ติดต่อเกี่ยวกับคิว ${booking.referenceNumber} วันที่ ${formatThaiDate(booking.date)}`,
                null,
                booking.id
            );
            
            // บันทึกข้อมูล
            setDoc(docRef, state.data);
            
            return chat;
        };

        // เพิ่มฟังก์ชันสำหรับแสดงหน้าต่างแชทสำหรับซัพพลายเออร์
        const renderSupplierChatView = (chat, booking) => {
            const modalContent = `
                <div class="flex flex-col h-[500px]">
                    <div class="bg-blue-50 p-4 rounded-t-lg border-b">
                        <h3 class="text-lg font-semibold">การสนทนากับพนักงาน</h3>
                        <div class="mt-2 text-sm text-gray-600">
                            <p><strong>เลขกำกับ:</strong> ${booking.referenceNumber}</p>
                            <p><strong>บริษัท:</strong> ${booking.companyName}</p>
                            <p><strong>วันที่:</strong> ${formatThaiDate(booking.date)}</p>
                            <p><strong>เวลา:</strong> ${formatTime24h(booking.eta)}</p>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4 bg-gray-50">
                        <div class="space-y-3">
                            ${chat.messages.map(message => {
                                const isSent = message.senderId === booking.companyName;
                                return `
                                <div class="flex ${isSent ? 'justify-end' : 'justify-start'}">
                                    <div class="max-w-[70%] p-3 rounded-lg ${isSent ? 'bg-blue-100 text-blue-800' : 'bg-white'}">
                                        <p>${message.content}</p>
                                        <p class="text-xs text-gray-500 mt-1">${formatDateTime(message.timestamp)}</p>
                                    </div>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    <div class="p-4 border-t bg-white rounded-b-lg">
                        <div class="flex gap-2">
                            <input type="text" id="supplier-message-input" placeholder="พิมพ์ข้อความ..." class="input flex-1">
                            <button id="send-supplier-message-btn" class="btn btn-primary">ส่ง</button>
                        </div>
                    </div>
                </div>
            `;
            
            renderModalBase(modalContent, modal => {
                const messageInput = modal.querySelector('#supplier-message-input');
                const sendButton = modal.querySelector('#send-supplier-message-btn');
                
                const sendMessage = () => {
                    const message = messageInput.value.trim();
                    if (!message) return;
                    
                    const newMessage = {
                        id: Date.now(),
                        senderId: booking.companyName,
                        content: message,
                        timestamp: new Date().toISOString()
                    };
                    
                    chat.messages.push(newMessage);
                    chat.lastUpdated = new Date().toISOString();
                    
                    // สร้างการแจ้งเตือนสำหรับพนักงาน
                    createNotification(
                        'message',
                        `ข้อความใหม่จาก ${booking.companyName}`,
                        message,
                        null,
                        booking.id
                    );
                    
                    // บันทึกข้อมูล
                    setDoc(docRef, state.data);
                    
                    messageInput.value = '';
                    renderSupplierChatView(chat, booking);
                };
                
                sendButton.addEventListener('click', sendMessage);
                messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') sendMessage();
                });
            });
        };
        
        const renderCompanyKpiDetails = (companyName) => {
            const kpiData = getKpiData();
            const companyData = kpiData.find(c => c.name === companyName);
            
            if (!companyData || !companyData.bookings || companyData.bookings.length === 0) {
                showAlert('ไม่พบข้อมูลการจัดส่งของบริษัทนี้');
                return;
            }
            
            const bookingDetailsHtml = companyData.bookings.map(booking => {
                const scoreClass = booking.score >= 4 ? 'kpi-score-high' : 
                                  booking.score >= 2.5 ? 'kpi-score-medium' : 'kpi-score-low';
                
                return `
                <div class="kpi-booking-item">
                    <div class="kpi-booking-details">
                        <div>
                            <span class="kpi-booking-date">${formatThaiDate(booking.date)} ${formatTime24h(booking.eta)}</span>
                            <div class="text-sm text-gray-600 mt-1">
                                คนขับ: ${booking.driverName} | ทะเบียน: ${booking.licensePlate}
                            </div>
                        </div>
                        <div class="kpi-booking-score ${scoreClass}">
                            ${booking.score.toFixed(1)}/5.0
                        </div>
                    </div>
                </div>
                `;
            }).join('');
            
            const modalContent = `
                <div class="mb-4">
                    <button id="back-to-kpi-btn" class="text-violet-600 hover:text-violet-800 flex items-center gap-1">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                        กลับไปยังรายการ KPI
                    </button>
                </div>
                <h3 class="text-xl font-bold mb-4">ประวัติการจัดส่ง: ${companyName}</h3>
                <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                    <div class="flex justify-between items-center">
                        <span class="font-medium">คะแนนเฉลี่ย:</span>
                        <span class="font-bold text-lg ${companyData.averageScore >= 4 ? 'text-green-500' : companyData.averageScore >= 2.5 ? 'text-yellow-500' : 'text-red-500'}">
                            ${companyData.averageScore.toFixed(2)}/5.0
                        </span>
                    </div>
                    <div class="flex justify-between items-center mt-2">
                        <span class="font-medium">จำนวนครั้งที่จัดส่ง:</span>
                        <span class="font-bold">${companyData.bookings.length} ครั้ง</span>
                    </div>
                </div>
                <div class="kpi-company-details">
                    <h4 class="font-semibold mb-2">รายละเอียดการจัดส่ง</h4>
                    <div class="space-y-2 max-h-96 overflow-y-auto custom-scroll">
                        ${bookingDetailsHtml}
                    </div>
                </div>
                <div class="flex justify-end gap-2 mt-4">
                    <button type="button" class="close-modal-btn btn btn-secondary">ปิด</button>
                </div>
            `;
            
            renderModalBase(modalContent, modal => {
                modal.querySelector('#back-to-kpi-btn')?.addEventListener('click', () => {
                    closeModal(modal);
                });
            });
        };
        
        const attachCalendarListeners = () => {
            document.getElementById('prev-month-btn')?.addEventListener('click', () => { 
                const newDate = new Date(state.currentDate);
                newDate.setMonth(newDate.getMonth() - 1);
                state.currentDate = newDate;
                render(); 
            });
            
            document.getElementById('next-month-btn')?.addEventListener('click', () => { 
                const newDate = new Date(state.currentDate);
                newDate.setMonth(newDate.getMonth() + 1);
                state.currentDate = newDate;
                render(); 
            });
            
            document.querySelectorAll('.calendar-day').forEach(day => {
                day.addEventListener('click', (e) => { 
                    const clickedDate = e.currentTarget.dataset.date;
                    const dateObj = new Date(clickedDate);
                    const dayOfWeek = dateObj.getDay();
                    
                    // Check if it's a weekend
                    if (dayOfWeek === 0 || dayOfWeek === 6) {
                        showAlert(`วันที่ ${formatThaiDate(clickedDate)} เป็นวันหยุดสุดสัปดาห์\nไม่สามารถจองคิวได้`);
                        return;
                    }
                    
                    // Check if it's a holiday
                    const holiday = isHoliday(dateObj);
                    if (holiday && holiday.type !== 'weekend') {
                        showAlert(`วันที่ ${formatThaiDate(clickedDate)} เป็นวันหยุด: ${holiday.name}\nไม่สามารถจองคิวได้`);
                        return;
                    }
                    
                    state.selectedDate = clickedDate;
                    state.currentView = 'dailyQueue'; 
                    render(); 
                });
            });
        };
        
        const attachKpiListeners = () => {
            document.getElementById('kpi-search').addEventListener('input', e => { state.kpiSearchTerm = e.target.value; render(); });
            const kpiData = getKpiData().slice(0, 5);
            const ctx = document.getElementById('kpi-chart')?.getContext('2d');
            if (ctx) {
                new Chart(ctx, { type: 'bar', data: { labels: kpiData.map(d => d.name), datasets: [{ label: 'คะแนนเฉลี่ย', data: kpiData.map(d => d.averageScore), backgroundColor: ['#a78bfa', '#7dd3fc', '#6ee7b7', '#fde047', '#f87171'] }] }, options: { indexAxis: 'y', responsive: true, plugins: { legend: { display: false } } } });
            }
        };

        const attachBookingDetailsListeners = () => {
            document.getElementById('search-reference-btn')?.addEventListener('click', handleSearchByReference);
            document.getElementById('reference-search')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleSearchByReference();
            });
            document.querySelectorAll('.view-details-btn').forEach(btn => btn.addEventListener('click', (e) => { 
                state.selectedBookingId = e.currentTarget.dataset.bookingId; 
                renderModal('bookingDetails', { bookingId: e.currentTarget.dataset.bookingId }); 
            }));
        };

        const attachScannerListeners = () => {
            document.getElementById('start-camera-btn')?.addEventListener('click', startCamera);
            document.getElementById('stop-camera-btn')?.addEventListener('click', stopCamera);
            document.getElementById('manual-input-btn')?.addEventListener('click', () => {
                renderModal('manualReferenceInput');
            });
        };

        let videoStream = null;
        let scanInterval = null;

        const startCamera = async () => {
            try {
                const video = document.getElementById('video');
                const startBtn = document.getElementById('start-camera-btn');
                const stopBtn = document.getElementById('stop-camera-btn');

                videoStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                video.srcObject = videoStream;

                startBtn.classList.add('hidden');
                stopBtn.classList.remove('hidden');

                scanInterval = setInterval(scanQRCode, 300);
            } catch (error) {
                console.error('Error accessing camera:', error);
                showAlert('ไม่สามารถเข้าถึงกล้องได้ กรุณาตรวจสอบการอนุญาตการใช้กล้อง');
            }
        };

        const stopCamera = () => {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }

            if (scanInterval) {
                clearInterval(scanInterval);
                scanInterval = null;
            }

            const video = document.getElementById('video');
            const startBtn = document.getElementById('start-camera-btn');
            const stopBtn = document.getElementById('stop-camera-btn');

            video.srcObject = null;
            startBtn.classList.remove('hidden');
            stopBtn.classList.add('hidden');
        };

        const scanQRCode = () => {
            const video = document.getElementById('video');
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');

            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);

                if (code) {
                    clearInterval(scanInterval);
                    handleQRCodeScanned(code.data);
                    setTimeout(() => {
                        stopCamera();
                    }, 1000);
                }
            }
        };

        const handleQRCodeScanned = (qrData) => {
            try {
                const data = JSON.parse(qrData);
                const booking = findBookingByReferenceNumber(data.referenceNumber);
                
                if (booking) {
                    renderModal('bookingCard', { booking });
                } else {
                    showAlert('ไม่พบข้อมูลการจองคิวที่ตรงกับ QR Code นี้');
                }
            } catch (error) {
                showAlert('QR Code ไม่ถูกต้อง กรุณาลองใหม่');
            }
        };

        const attachDailyQueueListeners = () => {
            document.getElementById('back-to-calendar-btn').addEventListener('click', () => { state.currentView = 'calendar'; state.selectedDate = null; render(); });
            document.getElementById('book-slot-btn')?.addEventListener('click', () => renderModal('booking'));
            document.querySelectorAll('.view-details-btn').forEach(btn => btn.addEventListener('click', (e) => { 
                state.selectedBookingId = e.currentTarget.dataset.bookingId; 
                renderModal('bookingDetails', { bookingId: e.currentTarget.dataset.bookingId }); 
            }));
            
            // Check-in button
            document.querySelectorAll('.check-in-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const bookingId = e.currentTarget.dataset.bookingId;
                handleCheckIn(bookingId);
            }));
            
            // Complete button
            document.querySelectorAll('.complete-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const bookingId = e.currentTarget.dataset.bookingId;
                handleCompleteBooking(bookingId);
            }));
            
            document.querySelectorAll('.evaluate-btn').forEach(btn => btn.addEventListener('click', (e) => { state.selectedBookingId = e.currentTarget.dataset.bookingId; renderModal('evaluate'); }));
            document.querySelectorAll('.delete-booking-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const bookingId = e.currentTarget.dataset.bookingId;
                showConfirm('คุณต้องการลบคิวนี้ใช่หรือไม่?', () => handleDeleteBooking(bookingId));
            }));
        };

        const handleCheckIn = async (bookingId) => {
            try {
                let bookingToUpdate = null;
                let bookingDate = null;

                // Find the booking and its date in the state
                for (const date in state.data.bookings) {
                    const bookingIndex = state.data.bookings[date].findIndex(b => b.id == bookingId);
                    if (bookingIndex !== -1) {
                        bookingToUpdate = state.data.bookings[date][bookingIndex];
                        bookingDate = date;
                        break;
                    }
                }

                if (!bookingToUpdate) {
                    showAlert('ไม่พบข้อมูลการจองคิว');
                    return;
                }

                // Update the original booking object in the state
                bookingToUpdate.checkInTime = new Date().toISOString();
                
                // สร้างการแจ้งเตือนเมื่อซัพพลายเออร์มาถึง
                createNotification(
                    'arrival',
                    'ซัพพลายเออร์มาถึงแล้ว',
                    `${bookingToUpdate.companyName} มาถึงคลังสินค้าแล้วเวลา ${formatDateTime(new Date())}`,
                    null,
                    bookingId
                );
                
                // Save to database
                await setDoc(docRef, state.data);
                
                showSuccessAnimation('เช็คอินสำเร็จแล้ว');
                render();
                
            } catch (error) {
                console.error('Error checking in:', error);
                showAlert('เกิดข้อผิดพลาดในการเช็คอิน กรุณาลองใหม่');
            }
        };

        const handleCompleteBooking = async (bookingId) => {
            try {
                let bookingToUpdate = null;
                let bookingDate = null;

                for (const date in state.data.bookings) {
                    const bookingIndex = state.data.bookings[date].findIndex(b => b.id == bookingId);
                    if (bookingIndex !== -1) {
                        bookingToUpdate = state.data.bookings[date][bookingIndex];
                        bookingDate = date;
                        break;
                    }
                }

                if (!bookingToUpdate) {
                    showAlert('ไม่พบข้อมูลการจองคิว');
                    return;
                }

                // Update the original booking object in the state
                bookingToUpdate.status = 'completed';
                bookingToUpdate.completedTime = new Date().toISOString();
                
                // Save to database
                await setDoc(docRef, state.data);
                
                showSuccessAnimation('ยืนยันการรับคิวสำเร็จแล้ว');
                render();
                
            } catch (error) {
                console.error('Error completing booking:', error);
                showAlert('เกิดข้อผิดพลาดในการยืนยันการรับคิว กรุณาลองใหม่');
            }
        };
        
        // แก้ไขฟังก์ชันเลือกเวลาให้เพิ่มทีละ 10 นาที
        const renderTimePickerModal = (bookingModal) => {
            const modalContent = `
                <div class="flex justify-center items-center gap-2 mb-4">
                    <span id="hour-preview" class="text-4xl font-bold text-violet-500 cursor-pointer">--</span>
                    <span class="text-4xl font-bold">:</span>
                    <span id="minute-preview" class="text-4xl font-bold cursor-pointer">--</span>
                </div>
                <div id="clock-container" class="clock-picker"></div>
                <div class="flex justify-end gap-2 pt-4">
                    <button type="button" class="close-modal-btn btn btn-secondary">ยกเลิก</button>
                    <button type="button" id="confirm-time-btn" class="btn btn-success" disabled>ยืนยัน</button>
                </div>`;
            
            renderModalBase(modalContent, modal => {
                let selectedHour = null;
                let selectedMinute = null;
                let currentPickerView = 'hours';

                const hourPreview = modal.querySelector('#hour-preview');
                const minutePreview = modal.querySelector('#minute-preview');
                const confirmBtn = modal.querySelector('#confirm-time-btn');
                const clockContainer = modal.querySelector('#clock-container');

                const updatePreview = () => {
                    hourPreview.textContent = selectedHour !== null ? selectedHour.toString().padStart(2, '0') : '--';
                    minutePreview.textContent = selectedMinute !== null ? selectedMinute.toString().padStart(2, '0') : '--';
                    confirmBtn.disabled = selectedHour === null || selectedMinute === null;
                };

                const attachClockListeners = () => {
                    if (currentPickerView === 'hours') {
                        clockContainer.querySelectorAll('.clock-number:not(.disabled)').forEach(btn => {
                            btn.addEventListener('click', () => {
                                selectedHour = parseInt(btn.dataset.hour);
                                currentPickerView = 'minutes';
                                hourPreview.classList.remove('text-violet-500');
                                minutePreview.classList.add('text-violet-500');
                                renderClock();
                            });
                        });
                    } else {
                        clockContainer.querySelectorAll('.clock-number:not(.disabled)').forEach(btn => {
                            btn.addEventListener('click', () => {
                                selectedMinute = parseInt(btn.dataset.minute);
                                clockContainer.querySelectorAll('[data-minute]').forEach(b => b.classList.remove('selected'));
                                btn.classList.add('selected');
                                updatePreview();
                            });
                        });
                    }
                };
                
                const renderClock = () => {
                    clockContainer.innerHTML = ''; 
                    const clockFace = document.createElement('div');
                    clockFace.className = 'clock-face';
                    const clockCenter = document.createElement('div');
                    clockCenter.className = 'clock-center';
                    clockFace.appendChild(clockCenter);

                    if (currentPickerView === 'hours') {
                        for (let i = 1; i <= 12; i++) {
                            const angle = (i / 12) * 360 - 90;
                            const x = 112 + 95 * Math.cos(angle * Math.PI / 180);
                            const y = 112 + 95 * Math.sin(angle * Math.PI / 180);
                            const numberEl = document.createElement('div');
                            numberEl.className = 'clock-number';
                            numberEl.textContent = i;
                            numberEl.style.left = `${x}px`;
                            numberEl.style.top = `${y}px`;
                            numberEl.dataset.hour = i;
                            clockFace.appendChild(numberEl);
                        }
                         for (let i = 13; i <= 24; i++) {
                            const displayHour = i === 24 ? '00' : i;
                            const dataHour = i === 24 ? 0 : i;
                            const angle = ((i-12) / 12) * 360 - 90;
                            const x = 112 + 60 * Math.cos(angle * Math.PI / 180);
                            const y = 112 + 60 * Math.sin(angle * Math.PI / 180);
                            const numberEl = document.createElement('div');
                            numberEl.className = `clock-number ${dataHour > 14 ? 'disabled' : ''}`;
                            numberEl.textContent = displayHour;
                            numberEl.style.left = `${x}px`;
                            numberEl.style.top = `${y}px`;
                            numberEl.dataset.hour = dataHour;
                            clockFace.appendChild(numberEl);
                        }
                    } else {
                        // เปลี่ยนจาก 15 นาที เป็น 10 นาที
                        ['00', '10', '20', '30', '40', '50'].forEach((minute, index) => {
                            const angle = ((index * 2) / 12) * 360 - 90;
                            const x = 112 + 95 * Math.cos(angle * Math.PI / 180);
                            const y = 112 + 95 * Math.sin(angle * Math.PI / 180);
                            const numberEl = document.createElement('div');
                            numberEl.className = 'clock-number';
                            if (selectedHour === 14 && minute !== '00') {
                                numberEl.classList.add('disabled');
                            }
                            numberEl.textContent = minute;
                            numberEl.style.left = `${x}px`;
                            numberEl.style.top = `${y}px`;
                            numberEl.dataset.minute = minute;
                            clockFace.appendChild(numberEl);
                        });
                    }
                    clockContainer.appendChild(clockFace);
                    updatePreview();
                    attachClockListeners();
                };

                renderClock();

                hourPreview.addEventListener('click', () => {
                    currentPickerView = 'hours';
                    hourPreview.classList.add('text-violet-500');
                    minutePreview.classList.remove('text-violet-500');
                    renderClock();
                });
                 minutePreview.addEventListener('click', () => {
                    if (selectedHour === null) return;
                    currentPickerView = 'minutes';
                    hourPreview.classList.remove('text-violet-500');
                    minutePreview.classList.add('text-violet-500');
                    renderClock();
                });

                confirmBtn.addEventListener('click', () => {
                    if (selectedHour !== null && selectedMinute !== null) {
                        const finalTime = `${selectedHour.toString().padStart(2,'0')}:${selectedMinute.toString().padStart(2,'0')}`;
                        bookingModal.querySelector('#eta').value = finalTime;
                        bookingModal.querySelector('#eta-display').textContent = finalTime;
                        bookingModal.querySelector('#eta-display').classList.remove('text-slate-500');
                        closeModal(modal);
                    }
                });
            });
        };

        const renderAddHolidayModal = () => {
            const modalContent = `
                <h3 class="text-xl font-bold mb-4">เพิ่มวันหยุด</h3>
                <form id="holiday-form" class="space-y-4">
                    <div>
                        <label class="text-sm font-medium">ชื่อวันหยุด</label>
                        <input type="text" id="holiday-name" placeholder="เช่น วันหยุดปีใหม่" class="input w-full mt-1" required>
                    </div>
                    <div>
                        <label class="text-sm font-medium">วันที่</label>
                        <input type="date" id="holiday-date" class="input w-full mt-1" required>
                    </div>
                    <div>
                        <label class="text-sm font-medium">ประเภทวันหยุด</label>
                        <select id="holiday-type" class="input w-full mt-1" required>
                            <option value="company">วันหยุดบริษัท</option>
                            <option value="public">วันหยุดราชการ</option>
                            <option value="special">วันหยุดพิเศษ</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="holiday-recurring" class="w-4 h-4">
                        <label for="holiday-recurring" class="text-sm">วันหยุดทุกปี (ประจำปี)</label>
                    </div>
                    <div>
                        <label class="text-sm font-medium">รายละเอียดเพิ่มเติม (ไม่บังคับ)</label>
                        <textarea id="holiday-description" placeholder="รายละเอียดเพิ่มเติม..." rows="3" class="input w-full mt-1"></textarea>
                    </div>
                    <div class="flex justify-end gap-2 pt-4">
                        <button type="button" class="close-modal-btn btn btn-secondary">ยกเลิก</button>
                        <button type="submit" class="btn btn-primary">บันทึก</button>
                    </div>
                </form>
            `;
            
            renderModalBase(modalContent, modal => {
                modal.querySelector('#holiday-form').addEventListener('submit', handleAddHoliday);
            });
        };

        const renderImportPublicHolidaysModal = () => {
            const currentYear = new Date().getFullYear();
            const years = [currentYear, currentYear + 1, currentYear + 2];
            
            const modalContent = `
                <h3 class="text-xl font-bold mb-4">นำเข้าวันหยุดราชการ</h3>
                <form id="import-holidays-form" class="space-y-4">
                    <div>
                        <label class="text-sm font-medium">เลือกปี</label>
                        <select id="holiday-year" class="input w-full mt-1" required>
                            ${years.map(year => `<option value="${year}">ปี ${year + 543}</option>`).join('')}
                        </select>
                    </div>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <div class="flex items-start gap-2">
                            <svg class="w-5 h-5 text-yellow-600 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                            </svg>
                            <div class="text-sm text-yellow-800">
                                <p class="font-medium">ข้อมูลวันหยุดราชการ</p>
                                <p class="mt-1">ระบบจะนำเข้าวันหยุดราชการตามประกาศสำนักนายกรัฐมนตรี ประกอบด้วย:</p>
                                <ul class="mt-2 list-disc list-inside space-y-1">
                                    <li>วันหยุดประจำปี</li>
                                    <li>วันหยุดพระราชพิธี</li>
                                    <li>วันหยุดตามศาสนา</li>
                                    <li>วันหยุดชดเชย</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end gap-2 pt-4">
                        <button type="button" class="close-modal-btn btn btn-secondary">ยกเลิก</button>
                        <button type="submit" class="btn btn-primary">นำเข้าข้อมูล</button>
                    </div>
                </form>
            `;
            
            renderModalBase(modalContent, modal => {
                modal.querySelector('#import-holidays-form').addEventListener('submit', handleImportPublicHolidays);
            });
        };

        const renderAddUserModal = () => {
            const modalContent = `
                <h3 class="text-xl font-bold mb-4">เพิ่มผู้ใช้</h3>
                <form id="user-form" class="space-y-4">
                    <div>
                        <label class="text-sm font-medium">ชื่อ</label>
                        <input type="text" id="user-name" placeholder="ชื่อผู้ใช้" class="input w-full mt-1" required>
                    </div>
                    <div>
                        <label class="text-sm font-medium">อีเมล</label>
                        <input type="email" id="user-email" placeholder="อีเมล" class="input w-full mt-1" required>
                    </div>
                    <div>
                        <label class="text-sm font-medium">รหัสผ่าน</label>
                        <input type="password" id="user-password" placeholder="รหัสผ่าน" class="input w-full mt-1" required>
                    </div>
                    <div>
                        <label class="text-sm font-medium">บทบาท</label>
                        <select id="user-role" class="input w-full mt-1" required>
                            <option value="viewer">ผู้ดู</option>
                            <option value="staff">พนักงาน</option>
                            <option value="admin">ผู้ดูแลระบบ</option>
                        </select>
                    </div>
                    <div class="flex justify-end gap-2 pt-4">
                        <button type="button" class="close-modal-btn btn btn-secondary">ยกเลิก</button>
                        <button type="submit" class="btn btn-primary">บันทึก</button>
                    </div>
                </form>
            `;
            
            renderModalBase(modalContent, modal => {
                modal.querySelector('#user-form').addEventListener('submit', handleAddUser);
            });
        };

        const renderEditUserModal = (userId) => {
            const user = state.data.users.find(u => u.id === userId);
            
            if (!user) {
                showAlert('ไม่พบข้อมูลผู้ใช้');
                return;
            }
            
            const modalContent = `
                <h3 class="text-xl font-bold mb-4">แก้ไขผู้ใช้</h3>
                <form id="user-form" class="space-y-4">
                    <input type="hidden" id="user-id" value="${user.id}">
                    <div>
                        <label class="text-sm font-medium">ชื่อ</label>
                        <input type="text" id="user-name" value="${user.name}" placeholder="ชื่อผู้ใช้" class="input w-full mt-1" required>
                    </div>
                    <div>
                        <label class="text-sm font-medium">อีเมล</label>
                        <input type="email" id="user-email" value="${user.email}" placeholder="อีเมล" class="input w-full mt-1" required>
                    </div>
                    <div>
                        <label class="text-sm font-medium">รหัสผ่าน (ปล่อยว่างหากไม่ต้องการเปลี่ยน)</label>
                        <input type="password" id="user-password" placeholder="รหัสผ่านใหม่" class="input w-full mt-1">
                    </div>
                    <div>
                        <label class="text-sm font-medium">บทบาท</label>
                        <select id="user-role" class="input w-full mt-1" required>
                            <option value="viewer" ${user.role === 'viewer' ? 'selected' : ''}>ผู้ดู</option>
                            <option value="staff" ${user.role === 'staff' ? 'selected' : ''}>พนักงาน</option>
                            <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>ผู้ดูแลระบบ</option>
                        </select>
                    </div>
                    <div class="flex justify-end gap-2 pt-4">
                        <button type="button" class="close-modal-btn btn btn-secondary">ยกเลิก</button>
                        <button type="submit" class="btn btn-primary">บันทึก</button>
                    </div>
                </form>
            `;
            
            renderModalBase(modalContent, modal => {
                modal.querySelector('#user-form').addEventListener('submit', handleEditUser);
            });
        };

        const handleAddUser = async (e) => {
            e.preventDefault();
            const form = e.target;
            
            const newUser = {
                id: Date.now().toString(),
                name: form.querySelector('#user-name').value,
                email: form.querySelector('#user-email').value,
                password: form.querySelector('#user-password').value,
                role: form.querySelector('#user-role').value,
                createdAt: new Date().toISOString(),
                lastLogin: null
            };
            
            if (!state.data.users) {
                state.data.users = [];
            }
            
            state.data.users.push(newUser);
            
            await setDoc(docRef, state.data);
            
            closeModal(form.closest('.modal-backdrop'));
            showSuccessAnimation('เพิ่มผู้ใช้สำเร็จแล้ว');
            render();
        };

        const handleEditUser = async (e) => {
            e.preventDefault();
            const form = e.target;
            const userId = form.querySelector('#user-id').value;
            
            const userIndex = state.data.users.findIndex(u => u.id === userId);
            
            if (userIndex === -1) {
                showAlert('ไม่พบข้อมูลผู้ใช้');
                return;
            }
            
            const updatedUser = {
                ...state.data.users[userIndex],
                name: form.querySelector('#user-name').value,
                email: form.querySelector('#user-email').value,
                role: form.querySelector('#user-role').value
            };
            
            const newPassword = form.querySelector('#user-password').value;
            if (newPassword) {
                updatedUser.password = newPassword;
            }
            
            state.data.users[userIndex] = updatedUser;
            
            await setDoc(docRef, state.data);
            
            closeModal(form.closest('.modal-backdrop'));
            showSuccessAnimation('แก้ไขผู้ใช้สำเร็จแล้ว');
            render();
        };

        const handleDeleteUser = async (userId) => {
            try {
                const userIndex = state.data.users.findIndex(u => u.id === userId);
                
                if (userIndex === -1) {
                    showAlert('ไม่พบข้อมูลผู้ใช้');
                    return;
                }
                
                state.data.users.splice(userIndex, 1);
                
                await setDoc(docRef, state.data);
                
                showAlert('ลบผู้ใช้สำเร็จแล้ว');
                render();
                
            } catch (error) {
                console.error('Error deleting user:', error);
                showAlert('เกิดข้อผิดพลาดในการลบผู้ใช้ กรุณาลองใหม่');
            }
        };

        const updateUnreadNotifications = () => {
            state.unreadNotifications = state.data.notifications.filter(n => 
                !n.read && (!n.userId || n.userId === state.currentUser?.id)
            ).length;
        };

        const handleAddHoliday = async (e) => {
            e.preventDefault();
            const form = e.target;
            
            const holiday = {
                id: Date.now(),
                name: form.querySelector('#holiday-name').value,
                date: form.querySelector('#holiday-date').value,
                type: form.querySelector('#holiday-type').value,
                recurring: form.querySelector('#holiday-recurring').checked,
                description: form.querySelector('#holiday-description').value
            };
            
            if (!state.data.holidays) {
                state.data.holidays = [];
            }
            
            state.data.holidays.push(holiday);
            state.data.holidays.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            await setDoc(docRef, state.data);
            
            closeModal(form.closest('.modal-backdrop'));
            showSuccessAnimation('เพิ่มวันหยุดสำเร็จแล้ว');
            render();
        };

        window.deleteHoliday = async (index) => {
            showConfirm('คุณต้องการลบวันหยุดนี้ใช่หรือไม่?', async () => {
                state.data.holidays.splice(index, 1);
                await setDoc(docRef, state.data);
                showAlert('ลบวันหยุดสำเร็จแล้ว');
                render();
            });
        };

        const handleImportPublicHolidays = async (e) => {
            e.preventDefault();
            const form = e.target;
            const year = parseInt(form.querySelector('#holiday-year').value);
            
            const publicHolidays = [
                { name: 'วันขึ้นปีใหม่', date: `${year}-01-01`, type: 'public', recurring: true },
                { name: 'วันมาฆบูชา', date: `${year}-02-26`, type: 'public', recurring: true },
                { name: 'วันจักรี', date: `${year}-04-06`, type: 'public', recurring: true },
                { name: 'วันสงกรานต์', date: `${year}-04-13`, type: 'public', recurring: true },
                { name: 'วันสงกรานต์ (ชดเชย)', date: `${year}-04-16`, type: 'public', recurring: true },
                { name: 'วันพืชมงคล', date: `${year}-05-01`, type: 'public', recurring: true },
                { name: 'วันวิสาขบูชา', date: `${year}-05-22`, type: 'public', recurring: true },
                { name: 'วันเฉลิมพระชนมพรรษา สมเด็จพระเจ้าอยู่หัว', date: `${year}-07-28`, type: 'public', recurring: true },
                { name: 'วันแม่แห่งชาติ', date: `${year}-08-12`, type: 'public', recurring: true },
                { name: 'วันคล้ายราชวงศ์', date: `${year}-10-23`, type: 'public', recurring: true },
                { name: 'วันปิยมหาราช', date: `${year}-10-23`, type: 'public', recurring: true },
                { name: 'วันลอยกระทง', date: `${year}-11-15`, type: 'public', recurring: true },
                { name: 'วันรัฐธรรมนูญ', date: `${year}-12-10`, type: 'public', recurring: true },
                { name: 'วันคริสต์มาสต์', date: `${year}-12-25`, type: 'public', recurring: true }
            ];
            
            if (!state.data.holidays) {
                state.data.holidays = [];
            }
            
            let addedCount = 0;
            publicHolidays.forEach(holiday => {
                const exists = state.data.holidays.some(h => 
                    h.date === holiday.date && h.type === 'public'
                );
                
                if (!exists) {
                    state.data.holidays.push({
                        ...holiday,
                        id: Date.now() + Math.random()
                    });
                    addedCount++;
                }
            });
            
            state.data.holidays.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            await setDoc(docRef, state.data);
            
            closeModal(form.closest('.modal-backdrop'));
            showSuccessAnimation(`นำเข้าวันหยุดราชการสำเร็จ ${addedCount} วัน`);
            render();
        };

        const renderModal = (type, data = {}) => {
            let modalContent = '';
            if(type === 'login') {
                modalContent = `<h3 class="text-xl font-bold mb-4">เข้าสู่ระบบพนักงาน</h3><form id="login-form"><input type="text" id="username" placeholder="ชื่อผู้ใช้" class="input w-full mb-4" required><button type="submit" class="btn btn-primary w-full">เข้าสู่ระบบ</button></form>`;
                renderModalBase(modalContent, modal => modal.querySelector('#login-form').addEventListener('submit', handleLogin));
            } 
            else if(type === 'booking') {
                if (isHoliday(new Date(state.selectedDate))) {
                    const holiday = isHoliday(new Date(state.selectedDate));
                    
                    modalContent = `
                        <div class="text-center">
                            <svg class="w-16 h-16 mx-auto text-red-500 mb-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                            </svg>
                            <h3 class="text-xl font-bold text-red-500 mb-2">ไม่สามารถจองคิวได้</h3>
                            <p class="mb-4">วันที่ ${formatThaiDate(state.selectedDate)} เป็นวันหยุด: ${holiday.name}</p>
                            <p class="text-sm text-gray-600">กรุณาเลือกวันอื่นเพื่อจองคิว</p>
                            <div class="flex justify-end gap-2 pt-4">
                                <button type="button" class="close-modal-btn btn btn-secondary">ปิด</button>
                            </div>
                        </div>
                    `;
                    renderModalBase(modalContent);
                    return;
                }

                if (checkDailyQueueLimit(state.selectedDate)) {
                    modalContent = `
                        <div class="text-center">
                            <svg class="w-16 h-16 mx-auto text-red-500 mb-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                            </svg>
                            <h3 class="text-xl font-bold text-red-500 mb-2">คิวเต็ม</h3>
                            <p class="mb-4">วันที่ ${formatThaiDate(state.selectedDate)} มีการจองคิวครบ 20 คิวแล้ว</p>
                            <p class="text-sm text-gray-600">กรุณาเลือกวันอื่นเพื่อจองคิว</p>
                            <div class="flex justify-end gap-2 pt-4">
                                <button type="button" class="close-modal-btn btn btn-secondary">ปิด</button>
                            </div>
                        </div>
                    `;
                    renderModalBase(modalContent);
                    return;
                }

                const companyOptions = state.data.companies.map(c => `<option value="${c}">${c}</option>`).join('');
                modalContent = `<h3 class="text-xl font-bold mb-4">จองคิววันที่ ${formatThaiDate(state.selectedDate)}</h3>
                <form id="booking-form" class="space-y-3">
                    <select id="company-name" class="input w-full" required><option value="">-- เลือกบริษัท --</option>${companyOptions}<option value="add_new">-- เพิ่มบริษัทใหม่ --</option></select>
                    <input type="text" id="new-company-name" placeholder="ชื่อบริษัทใหม่" class="input w-full hidden">
                    <input type="text" id="driver-name" placeholder="ชื่อ-นามสกุล คนขับ" class="input w-full" required>
                    <div>
                        <label class="text-sm font-medium">ทะเบียนรถ</label>
                        <div class="grid grid-cols-2 gap-2 mt-1">
                            <input type="text" id="license-plate-prefix" placeholder="หมวด (เช่น 1กก)" maxlength="4" class="input text-center" required>
                            <input type="text" id="license-plate-suffix" placeholder="เลข (เช่น 1234)" pattern="[0-9]*" maxlength="4" class="input text-center" oninput="this.value = this.value.replace(/[^0-9]/g, '')" required>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        <input type="text" id="invoice-count" placeholder="จำนวนบิล" class="input" oninput="this.value = this.value.replace(/[^0-9]/g, '')" required>
                        <input type="text" id="box-count" placeholder="จำนวนกล่อง" class="input" oninput="this.value = this.value.replace(/[^0-9]/g, '')" required>
                        <input type="text" id="item-count" placeholder="จำนวนชิ้น" class="input" oninput="this.value = this.value.replace(/[^0-9]/g, '')" required>
                    </div>
                     <div>
                         <label class="text-sm font-medium">เวลาที่คาดว่าจะมาถึง</label>
                         <div id="eta-display" class="input cursor-pointer mt-1 text-slate-500">-- เลือกเวลา --</div>
                         <input type="hidden" id="eta" required>
                    </div>
                    <div>
                        <label class="text-sm font-medium">เอกสารเพิ่มเติม</label>
                        <textarea id="notes" placeholder="รายละเอียดเพิ่มเติม" rows="2" class="input"></textarea>
                    </div>
                    <div class="border-t pt-3">
                        <label class="text-sm font-medium flex items-center gap-2">
                            <svg class="w-4 h-4 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                            </svg>
                            แนบเอกสาร (INVOICE และ PO)
                        </label>
                        <p class="text-xs text-gray-500 mt-1 mb-2">*หากแนบเอกสารมาด้วยจะเพิ่มความรวดเร็วในการรับสินค้าของพนักงาน</p>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-gray-400 transition-colors">
                            <input type="file" id="document-files" multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" class="hidden">
                            <label for="document-files" class="cursor-pointer">
                                <svg class="w-12 h-12 mx-auto text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                </svg>
                                <p class="text-sm text-gray-600">คลิกเพื่อเลือกไฟล์ หรือลากไฟล์มาวางที่นี่</p>
                                <p class="text-xs text-gray-500 mt-1">รองรับไฟล์ PDF, JPG, PNG, DOC, DOCX (สูงสุด 5MB ต่อไฟล์)</p>
                            </label>
                        </div>
                        <div id="file-list" class="mt-3 space-y-2"></div>
                    </div>
                    <div class="flex justify-end gap-2 pt-4">
                        <button type="button" class="close-modal-btn btn btn-secondary">ยกเลิก</button>
                        <button type="submit" class="btn btn-success">ยืนยันการจอง</button>
                    </div>
                </form>`;
                renderModalBase(modalContent, modal => {
                    modal.querySelector('#eta-display').addEventListener('click', () => renderTimePickerModal(modal));
                    const companySelect = modal.querySelector('#company-name'), newCompanyInput = modal.querySelector('#new-company-name');
                    companySelect.addEventListener('change', () => newCompanyInput.classList.toggle('hidden', companySelect.value !== 'add_new'));
                    
                    const fileInput = modal.querySelector('#document-files');
                    const fileList = modal.querySelector('#file-list');
                    let uploadedFiles = [];
                    
                    const displayFiles = () => {
                        fileList.innerHTML = uploadedFiles.map((file, index) => `
                            <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                                <div class="flex items-center gap-2">
                                    <svg class="w-5 h-5 text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"></path>
                                    </svg>
                                    <div>
                                        <p class="text-sm font-medium">${file.name}</p>
                                        <p class="text-xs text-gray-500">${formatFileSize(file.size)}</p>
                                    </div>
                                </div>
                                <button type="button" class="text-red-500 hover:text-red-700" onclick="removeFile(${index})">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                    </svg>
                                </button>
                            </div>
                        `).join('');
                    };
                    
                    window.removeFile = (index) => {
                        uploadedFiles.splice(index, 1);
                        displayFiles();
                    };
                    
                    fileInput.addEventListener('change', async (e) => {
                        const files = Array.from(e.target.files);
                        const validFiles = files.filter(file => {
                            const isValidType = ['application/pdf', 'image/jpeg', 'image/png', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'].includes(file.type);
                            const isValidSize = file.size <= 5 * 1024 * 1024;
                            if (!isValidType) {
                                showAlert(`ไฟล์ ${file.name} ไม่รองรับประเภทนี้`);
                                return false;
                            }
                            if (!isValidSize) {
                                showAlert(`ไฟล์ ${file.name} มีขนาดเกิน 5MB`);
                                return false;
                            }
                            return true;
                        });
                        
                        const newFiles = await handleFileUpload({ files: validFiles });
                        uploadedFiles = [...uploadedFiles, ...newFiles];
                        displayFiles();
                    });
                    
                    const dropZone = modal.querySelector('.border-dashed').parentElement;
                    
                    dropZone.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        dropZone.classList.add('border-blue-500', 'bg-blue-50');
                    });
                    
                    dropZone.addEventListener('dragleave', (e) => {
                        e.preventDefault();
                        dropZone.classList.remove('border-blue-500', 'bg-blue-50');
                    });
                    
                    dropZone.addEventListener('drop', async (e) => {
                        e.preventDefault();
                        dropZone.classList.remove('border-blue-500', 'bg-blue-50');
                        
                        const files = Array.from(e.dataTransfer.files);
                        const validFiles = files.filter(file => {
                            const isValidType = ['application/pdf', 'image/jpeg', 'image/png', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'].includes(file.type);
                            const isValidSize = file.size <= 5 * 1024 * 1024;
                            if (!isValidType) {
                                showAlert(`ไฟล์ ${file.name} ไม่รองรับประเภทนี้`);
                                return false;
                            }
                            if (!isValidSize) {
                                showAlert(`ไฟล์ ${file.name} มีขนาดเกิน 5MB`);
                                return false;
                            }
                            return true;
                        });
                        
                        const newFiles = await handleFileUpload({ files: validFiles });
                        uploadedFiles = [...uploadedFiles, ...newFiles];
                        displayFiles();
                    });
                    
                    // แก้ไขฟังก์ชันการจองคิว
                    modal.querySelector('#booking-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const form = e.target;
                        const companySelect = form.querySelector('#company-name');
                        let companyName = companySelect.value === 'add_new' ? form.querySelector('#new-company-name').value.trim() : companySelect.value;
                        
                        if (!companyName) { 
                            showAlert('กรุณาระบุชื่อบริษัท'); 
                            return; 
                        }
                        
                        const licensePlate = `${form.querySelector('#license-plate-prefix').value.trim()} ${form.querySelector('#license-plate-suffix').value.trim()}`.trim();
                        if (!licensePlate) { 
                            showAlert('กรุณากรอกทะเบียนรถ'); 
                            return; 
                        }

                        let eta = form.querySelector('#eta').value;
                        if (!eta) { 
                            showAlert('กรุณาเลือกเวลา'); 
                            return; 
                        }

                        let originalTime = eta;
                        let attempts = 0;
                        const maxAttempts = 10;
                        
                        // แก้ไขการตรวจสอบคิวซ้ำ
                        while (checkTimeConflict(state.selectedDate, eta) >= 2 && attempts < maxAttempts) {
                            eta = calculateNewTime(eta, 10);
                            attempts++;
                        }
                        
                        // ถ้ายังมีคิวซ้ำ 2 คิว ให้เพิ่มเป็น 15 นาที
                        if (checkTimeConflict(state.selectedDate, eta) >= 2 && attempts < maxAttempts) {
                            eta = calculateNewTime(eta, 5); // เพิ่ม 5 นาทีเพื่อให้เป็น 15 นาทีรวม
                            attempts++;
                        }
                        
                        // ตรวจสอบว่าเวลาที่เลือกเกิน 14:15 หรือไม่
                        const [hour, minute] = eta.split(':').map(Number);
                        if (hour === 14 && minute > 15) {
                            showAlert(`ไม่สามารถจองคิวได้ เนื่องจากเวลา ${eta} เกินเวลารับสินค้า (14:15)`);
                            return;
                        }
                        
                        // ตรวจสอบว่าในช่วงเวลาที่เลือกมีคิวอยู่แล้วหรือไม่
                        if (checkTimeConflict(state.selectedDate, eta) >= 2) {
                            showAlert(`ไม่สามารถจองคิวได้ เนื่องจากมีคิวในช่วงเวลานั้นแล้ว`);
                            return;
                        }

                        if (eta !== originalTime) {
                            showAlert(`เวลา ${originalTime} มีการจองแล้ว ระบบได้เลื่อนเวลาของคุณเป็น ${eta} โดยอัตโนมัติ`);
                        }

                        const referenceNumber = generateReferenceNumber();
                        const newBooking = { 
                            id: Date.now(), 
                            referenceNumber: referenceNumber,
                            companyName, 
                            driverName: form.querySelector('#driver-name').value, 
                            licensePlate, 
                            invoiceCount: form.querySelector('#invoice-count').value, 
                            boxCount: form.querySelector('#box-count').value, 
                            itemCount: form.querySelector('#item-count').value, 
                            eta, 
                            notes: form.querySelector('#notes').value,
                            documents: uploadedFiles,
                            evaluation: null 
                        };
                        
                        const dateStr = state.selectedDate;
                        if (!state.data.bookings[dateStr]) {
                            state.data.bookings[dateStr] = [];
                        }
                        state.data.bookings[dateStr].push(newBooking);
                        state.data.bookings[dateStr].sort((a,b) => a.eta.localeCompare(b.eta));
                        
                        await setDoc(docRef, state.data);

                        state.guestBookingIds.push(newBooking.id);
                        sessionStorage.setItem('guestBookingIds', JSON.stringify(state.guestBookingIds));
                        
                        closeModal(form.closest('.modal-backdrop')); 
                        renderModal('qrCode', { booking: newBooking });
                    });
                });
            }
            else if (type === 'bookingDetails') {
                const booking = findBookingById(data.bookingId);
                if (!booking) {
                    modalContent = `<p class="text-center text-red-500">ไม่พบข้อมูลการจองคิว</p>`;
                    renderModalBase(modalContent);
                    return;
                }

                const isGuestBooking = state.guestBookingIds.includes(booking.id);
                const isEditable = state.userRole === 'staff' || (state.userRole === 'guest' && isGuestBooking);
                
                const documentsHtml = booking.documents && booking.documents.length > 0 
                    ? `<div class="mt-4">
                        <h4 class="font-semibold text-gray-700 mb-2">เอกสารที่แนบ:</h4>
                        <div class="space-y-2">
                            ${booking.documents.map((doc, index) => `
                                <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                                    <div class="flex items-center gap-2">
                                        <svg class="w-5 h-5 text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"></path>
                                        </svg>
                                        <div>
                                            <p class="text-sm font-medium">${doc.name}</p>
                                            <p class="text-xs text-gray-500">${formatFileSize(doc.size)}</p>
                                        </div>
                                    </div>
                                    <button type="button" onclick="downloadDocument('${doc.name}', '${doc.data}')" class="text-blue-500 hover:text-blue-700 text-sm font-medium">
                                        ดาวน์โหลด
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>`
                    : '';
                
                // Determine status
                let statusBadge = '';
                if (booking.checkInTime) {
                    if (booking.status === 'completed') {
                        statusBadge = '<span class="status-badge status-completed">เสร็จสิ้น</span>';
                    } else if (checkIfLate(booking)) {
                        statusBadge = '<span class="status-badge status-late">มาสาย</span>';
                    } else {
                        statusBadge = '<span class="status-badge status-confirmed">เช็คอินแล้ว</span>';
                    }
                } else {
                    statusBadge = '<span class="status-badge status-pending">รอเช็คอิน</span>';
                }
                
                modalContent = `
                    <div class="booking-details p-4 rounded-lg">
                        <h3 class="text-xl font-bold mb-4">รายละเอียดการจองคิว</h3>
                        <div class="booking-details-grid">
                            <div class="detail-item">
                                <span class="detail-label">เลขกำกับ:</span>
                                <span class="detail-value reference-number">${booking.referenceNumber || '-'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">บริษัท:</span>
                                <span class="detail-value">${booking.companyName}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">วันที่:</span>
                                <span class="detail-value">${formatThaiDate(booking.date)}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">เวลา:</span>
                                <span class="detail-value">${formatTime24h(booking.eta)}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">ชื่อคนขับ:</span>
                                <span class="detail-value">${booking.driverName}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">ทะเบียนรถ:</span>
                                <span class="detail-value">${booking.licensePlate}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">จำนวนบิล:</span>
                                <span class="detail-value">${booking.invoiceCount}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">จำนวนกล่อง:</span>
                                <span class="detail-value">${booking.boxCount}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">จำนวนชิ้น:</span>
                                <span class="detail-value">${booking.itemCount}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">สถานะ:</span>
                                <span class="detail-value">${statusBadge}</span>
                            </div>
                            ${booking.checkInTime ? `
                            <div class="detail-item">
                                <span class="detail-label">เวลาเช็คอิน:</span>
                                <span class="detail-value">${formatDateTime(booking.checkInTime)}</span>
                            </div>
                            ` : ''}
                            ${booking.notes ? `
                            <div class="detail-item col-span-2">
                                <span class="detail-label">เอกสารเพิ่มเติม:</span>
                                <span class="detail-value">${booking.notes}</span>
                            </div>
                            ` : ''}
                        </div>
                        ${documentsHtml}
                        <div class="mt-4 flex justify-end gap-2">
                            <button type="button" class="close-modal-btn btn btn-secondary">ปิด</button>
                        </div>
                    </div>`;
                
                window.downloadDocument = (filename, dataUrl) => {
                    const link = document.createElement('a');
                    link.href = dataUrl;
                    link.download = filename;
                    link.click();
                };
                
                renderModalBase(modalContent);
            }
            else if (type === 'bookingCard') {
                const booking = data.booking;
                
                const documentsInfo = booking.documents && booking.documents.length > 0 
                    ? `<div class="booking-card-item">
                        <span class="booking-card-label">เอกสารที่แนบ:</span>
                        <span class="booking-card-value">${booking.documents.length} ไฟล์</span>
                    </div>`
                    : '';
                
                // Determine status
                let statusBadge = '';
                if (booking.checkInTime) {
                    if (booking.status === 'completed') {
                        statusBadge = '<span class="status-badge status-completed">เสร็จสิ้น</span>';
                    } else if (checkIfLate(booking)) {
                        statusBadge = '<span class="status-badge status-late">มาสาย</span>';
                    } else {
                        statusBadge = '<span class="status-badge status-confirmed">เช็คอินแล้ว</span>';
                    }
                } else {
                    statusBadge = '<span class="status-badge status-pending">รอเช็คอิน</span>';
                }
                
                // Check-in section for staff
                let checkInSection = '';
                if (state.userRole === 'staff' && !booking.checkInTime) {
                    checkInSection = `
                        <div class="check-in-section">
                            <h4 class="font-semibold text-green-700 mb-2">การเช็คอิน</h4>
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-sm">เวลาปัจจุบัน:</span>
                                <span class="check-in-time">${formatDateTime(new Date())}</span>
                            </div>
                            <button data-booking-id="${booking.id}" class="check-in-from-qr-btn btn btn-success w-full">
                                ${icons.check} เช็คอิน
                            </button>
                        </div>
                    `;
                } else if (state.userRole === 'staff' && booking.checkInTime && booking.status !== 'completed') {
                    checkInSection = `
                        <div class="check-in-section">
                            <h4 class="font-semibold text-blue-700 mb-2">การรับสินค้า</h4>
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-sm">เวลาเช็คอิน:</span>
                                <span class="check-in-time">${formatDateTime(booking.checkInTime)}</span>
                            </div>
                            <button data-booking-id="${booking.id}" class="complete-from-qr-btn btn btn-primary w-full">
                                ${icons.check} ยืนยันรับคิว
                            </button>
                        </div>
                    `;
                }
                
                modalContent = `
                    <div class="booking-card">
                        <div class="booking-card-inner">
                            <div class="booking-card-header">
                                <h3 class="booking-card-title">${booking.companyName}</h3>
                                <span class="booking-card-reference">${booking.referenceNumber}</span>
                            </div>
                            <div class="booking-card-grid">
                                <div class="booking-card-item">
                                    <span class="booking-card-label">วันที่</span>
                                    <span class="booking-card-value">${formatThaiDate(booking.date)}</span>
                                </div>
                                <div class="booking-card-item">
                                    <span class="booking-card-label">เวลา</span>
                                    <span class="booking-card-value">${formatTime24h(booking.eta)}</span>
                                </div>
                                <div class="booking-card-item">
                                    <span class="booking-card-label">คนขับ</span>
                                    <span class="booking-card-value">${booking.driverName}</span>
                                </div>
                                <div class="booking-card-item">
                                    <span class="booking-card-label">ทะเบียนรถ</span>
                                    <span class="booking-card-value">${booking.licensePlate}</span>
                                </div>
                                <div class="booking-card-item">
                                    <span class="booking-card-label">จำนวนบิล</span>
                                    <span class="booking-card-value">${booking.invoiceCount}</span>
                                </div>
                                <div class="booking-card-item">
                                    <span class="booking-card-label">จำนวนกล่อง</span>
                                    <span class="booking-card-value">${booking.boxCount}</span>
                                </div>
                                <div class="booking-card-item">
                                    <span class="booking-card-label">จำนวนชิ้น</span>
                                    <span class="booking-card-value">${booking.itemCount}</span>
                                </div>
                                <div class="booking-card-item">
                                    <span class="booking-card-label">สถานะ</span>
                                    <span class="booking-card-value">${statusBadge}</span>
                                </div>
                                ${documentsInfo}
                            </div>
                            ${booking.notes ? `
                            <div class="mt-2 p-3 bg-gray-50 rounded-lg">
                                <span class="booking-card-label">เอกสารเพิ่มเติม</span>
                                <p class="booking-card-value mt-1">${booking.notes}</p>
                            </div>
                            ` : ''}
                            ${booking.documents && booking.documents.length > 0 ? `
                            <div class="mt-2 p-3 bg-blue-50 rounded-lg">
                                <span class="booking-card-label text-blue-700">เอกสารที่แนบ</span>
                                <div class="mt-2 space-y-1">
                                    ${booking.documents.map(doc => `
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm text-gray-700">${doc.name}</span>
                                            <button type="button" onclick="downloadDocument('${doc.name}', '${doc.data}')" class="text-blue-500 hover:text-blue-700 text-xs">
                                                ดาวน์โหลด
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            ` : ''}
                            ${checkInSection}
                            <div class="booking-card-footer">
                                <div class="booking-card-status">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                    ${booking.status === 'completed' ? 'ดำเนินการเสร็จสิ้น' : booking.checkInTime ? 'กำลังดำเนินการ' : 'รอการดำเนินการ'}
                                </div>
                                <div class="booking-card-actions">
                                    ${state.userRole === 'staff' ? `<button data-booking-id="${booking.id}" class="booking-card-btn booking-card-btn-primary evaluate-from-qr-btn">ประเมิน KPI</button>` : ''}
                                    <button class="booking-card-btn booking-card-btn-secondary close-modal-btn">ปิด</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                renderModalBase(modalContent, modal => {
                    if (state.userRole === 'staff') {
                        modal.querySelector('.evaluate-from-qr-btn')?.addEventListener('click', () => {
                            closeModal(modal);
                            state.selectedDate = booking.date;
                            state.selectedBookingId = booking.id;
                            renderModal('evaluate');
                        });
                        
                        modal.querySelector('.check-in-from-qr-btn')?.addEventListener('click', () => {
                            handleCheckIn(booking.id);
                            closeModal(modal);
                        });
                        
                        modal.querySelector('.complete-from-qr-btn')?.addEventListener('click', () => {
                            handleCompleteBooking(booking.id);
                            closeModal(modal);
                        });
                    }
                });
            }
            else if (type === 'evaluate') {
                const booking = state.data.bookings[state.selectedDate]?.find(b => b.id == state.selectedBookingId);
                let kpiInputs = kpiDefinitions.map(kpi => `<div class="grid grid-cols-2 items-center gap-2"><label class="font-medium">${kpi.label}</label><select data-kpi-id="${kpi.id}" class="kpi-select input"><option value="0">-- เลือก --</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select></div>`).join('');
                
                modalContent = `<h3 class="text-xl font-bold mb-2">ประเมิน KPI</h3><p class="mb-4 text-slate-500">${booking.companyName}</p>
                <form id="evaluation-form" class="space-y-3">
                    ${kpiInputs}
                    <div class="border-t my-4"></div>
                    <textarea id="staff-comments" placeholder="ความคิดเห็นเพิ่มเติมจากพนักงาน" rows="3" class="input"></textarea>
                    <button type="button" id="generate-summary-btn" class="btn btn-primary w-full flex items-center justify-center gap-2">✨ สร้างสรุปผลด้วย AI</button>
                    <div id="gemini-loading" class="hidden text-center p-4">กำลังสร้างสรุป...</div>
                    <textarea id="gemini-summary" placeholder="สรุปผลจาก AI (แก้ไขได้)" rows="4" class="input mt-2"></textarea>
                    <div class="flex justify-end gap-2 pt-4">
                        <button type="button" class="close-modal-btn btn btn-secondary">ยกเลิก</button>
                        <button type="submit" class="btn btn-success">บันทึกผล</button>
                    </div>
                </form>`;
                renderModalBase(modalContent, modal => {
                    modal.querySelector('#evaluation-form').addEventListener('submit', handleEvaluationSubmit);
                    modal.querySelector('#generate-summary-btn').addEventListener('click', handleGenerateSummary);
                });
            } else if (type === 'qrCode') {
                const booking = data.booking;
                const referenceNumber = booking.referenceNumber || generateReferenceNumber();
                
                if (!booking.referenceNumber) {
                    booking.referenceNumber = referenceNumber;
                    const dateStr = state.selectedDate;
                    const bookingIndex = state.data.bookings[dateStr].findIndex(b => b.id === booking.id);
                    if (bookingIndex !== -1) {
                        state.data.bookings[dateStr][bookingIndex].referenceNumber = referenceNumber;
                        setDoc(docRef, state.data);
                    }
                }
                
                const qrData = JSON.stringify({
                    id: booking.id,
                    referenceNumber: referenceNumber,
                    company: booking.companyName,
                    date: state.selectedDate,
                    time: booking.eta,
                    driverName: booking.driverName,
                    licensePlate: booking.licensePlate,
                    invoiceCount: booking.invoiceCount,
                    boxCount: booking.boxCount,
                    itemCount: booking.itemCount,
                    notes: booking.notes || ''
                });

                modalContent = `
                    <div class="text-center">
                        <div class="inline-block p-4 rounded-lg bg-green-50 mb-4">
                            <svg class="w-16 h-16 mx-auto text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-green-500 mb-2">การจองคิวสำเร็จ!</h3>
                        <p class="mb-4">กรุณาแสดง QR Code นี้แก่เจ้าหน้าที่เมื่อมาถึง</p>
                        <div class="text-left bg-slate-50 p-3 rounded-lg mb-4">
                            <p><strong>เลขกำกับ:</strong> <span class="reference-number">${referenceNumber}</span></p>
                            <p><strong>บริษัท:</strong> ${booking.companyName}</p>
                            <p><strong>วันที่:</strong> ${formatThaiDate(state.selectedDate)}</p>
                            <p><strong>เวลา:</strong> ${formatTime24h(booking.eta)}</p>
                        </div>
                        <div id="qrcode-container" class="flex justify-center my-4 bg-white p-4 rounded-lg"></div>
                        <p class="mt-4 font-bold text-red-500">สำคัญ: กรุณาบันทึกภาพ QR Code นี้ไว้ในอัลบั้ม</p>
                        <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <p class="text-sm text-yellow-800">
                                <strong>หมายเหตุ:</strong> กรุณามาตามเวลาที่กำหนด 
                                <span class="font-bold text-red-600">หากมาช้าต้องไปต่อคิวตามปกติ</span>
                            </p>
                        </div>
                        <div class="flex justify-end gap-2 pt-4">
                            <button type="button" id="download-qr-btn" class="btn btn-primary">ดาวน์โหลด QR Code</button>
                            <button type="button" id="qr-close-btn" class="btn btn-success">ยืนยัน</button>
                        </div>
                    </div>`;

                renderModalBase(modalContent, modal => {
                    generateQRCode(qrData, modal.querySelector('#qrcode-container'));
                    
                    modal.querySelector('#qr-close-btn').addEventListener('click', () => {
                        closeModal(modal);
                        state.currentView = 'dailyQueue';
                        render();
                    });
                });
            } else if (type === 'manualReferenceInput') {
                modalContent = `
                    <h3 class="text-xl font-bold mb-4">ป้อนเลขกำกับ</h3>
                    <form id="manual-reference-form" class="space-y-4">
                        <input type="text" id="manual-reference-input" placeholder="กรุณาป้อนเลขกำกับ (เช่น QR2401231234)" class="input text-center text-lg font-mono" required>
                        <div class="flex justify-end gap-2">
                            <button type="button" class="close-modal-btn btn btn-secondary">ยกเลิก</button>
                            <button type="submit" class="btn btn-primary">ค้นหา</button>
                        </div>
                    </form>
                `;
                renderModalBase(modalContent, modal => {
                    modal.querySelector('#manual-reference-form').addEventListener('submit', (e) => {
                        e.preventDefault();
                        const referenceNumber = modal.querySelector('#manual-reference-input').value.trim();
                        closeModal(modal);
                        handleSearchByReferenceNumber(referenceNumber);
                    });
                });
            }
        };

        const findBookingById = (bookingId) => {
            for (const date in state.data.bookings) {
                const booking = state.data.bookings[date].find(b => b.id == bookingId);
                if (booking) {
                    return { ...booking, date };
                }
            }
            return null;
        };

        const handleSearchByReference = () => {
            const referenceNumber = document.getElementById('reference-search').value.trim();
            if (referenceNumber) {
                handleSearchByReferenceNumber(referenceNumber);
            }
        };

        const handleSearchByReferenceNumber = (referenceNumber) => {
            const booking = findBookingByReferenceNumber(referenceNumber);
            if (booking) {
                renderModal('bookingCard', { booking });
            } else {
                showAlert(`ไม่พบข้อมูลการจองคิวสำหรับเลขกำกับ: ${referenceNumber}`);
            }
        };

        async function callGemini(prompt) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    throw new Error(`API error: ${response.statusText}`);
                }
                const result = await response.json();
                return result.candidates?.[0]?.content?.parts?.[0]?.text || "ไม่สามารถสร้างสรุปได้";
            } catch (error) {
                console.error("Gemini API call failed:", error);
                return "เกิดข้อผิดพลาดในการเชื่อมต่อกับ AI";
            }
        }

        const handleGenerateSummary = async (e) => {
            const modal = e.target.closest('.modal-backdrop');
            const loadingIndicator = modal.querySelector('#gemini-loading');
            const summaryTextarea = modal.querySelector('#gemini-summary');
            const booking = state.data.bookings[state.selectedDate]?.find(b => b.id == state.selectedBookingId);

            loadingIndicator.style.display = 'block';
            summaryTextarea.value = '';

            let kpiScoresText = "";
            kpiDefinitions.forEach(kpi => {
                const score = modal.querySelector(`.kpi-select[data-kpi-id="${kpi.id}"]`).value;
                if(score > 0) {
                     kpiScoresText += `- ${kpi.label}: ${score}/5\n`;
                }
            });

            const staffComments = modal.querySelector('#staff-comments').value;

            const prompt = `
                 กรุณาสร้างบทสรุปผลการประเมินการจัดส่งสินค้าสำหรับซัพพลายเออร์ในรูปแบบที่เป็นทางการและกระชับเป็นภาษาไทย โดยใช้ข้อมูลต่อไปนี้:
                 - ชื่อซัพพลายเออร์: ${booking.companyName}
                 - วันที่จัดส่ง: ${formatThaiDate(state.selectedDate)}
                 - ผลการประเมิน KPI:
                 ${kpiScoresText}
                 - ความคิดเห็นเพิ่มเติมจากพนักงาน: ${staffComments || 'ไม่มี'}

                 ให้สรุปภาพรวมของประสิทธิภาพ และอาจจะมีการกล่าวถึงข้อดีหรือสิ่งที่ควรปรับปรุงตามความเหมาะสมจากคะแนนและความคิดเห็น
            `;

            const summary = await callGemini(prompt);
            summaryTextarea.value = summary;
            loadingIndicator.style.display = 'none';
        };

        const handleLogin = (e) => { 
            e.preventDefault(); 
            const username = document.getElementById('username').value.trim();
            
            // ตรวจสอบว่าเป็นผู้ใช้ที่มีอยู่ในระบบหรือไม่
            const user = state.data.users?.find(u => u.email === username || u.name === username);
            
            if (user) {
                // อัปเดตเวลาเข้าสู่ระบบล่าสุด
                user.lastLogin = new Date().toISOString();
                setDoc(docRef, state.data);
                
                state.isLoggedIn = true;
                state.userRole = user.role;
                state.currentUser = user;
                state.currentView = 'dashboard';
                closeModal();
                render();
            } else if (username === 'inboundlaksi') {
                // ยังคงการเข้าสู่ระบบแบบเก่าสำหรับความเข้ากันได้
                state.isLoggedIn = true;
                state.userRole = 'staff';
                state.currentUser = {
                    id: 'default',
                    name: 'พนักงาน',
                    email: 'inboundlaksi',
                    role: 'staff'
                };
                state.currentView = 'dashboard';
                closeModal();
                render();
            } else {
                showAlert('ชื่อผู้ใช้ไม่ถูกต้อง');
            }
        };
        
        const handleLogout = () => { 
            state.isLoggedIn = false;
            state.userRole = 'guest';
            state.currentUser = null;
            state.currentView = 'calendar';
            render();
        };
        
        const handleEvaluationSubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const booking = state.data.bookings[state.selectedDate].find(b => b.id == state.selectedBookingId);
            if(booking) {
                booking.evaluation = {
                    scores: {},
                    staffComments: form.querySelector('#staff-comments').value,
                    geminiSummary: form.querySelector('#gemini-summary').value
                };
                form.querySelectorAll('.kpi-select').forEach(sel => {
                    booking.evaluation.scores[sel.dataset.kpiId] = parseInt(sel.value, 10);
                });
                
                await setDoc(docRef, state.data);
                
                closeModal(form.closest('.modal-backdrop')); 
                showSuccessAnimation("บันทึกผลสำเร็จ!");
            }
        };

        const handleDeleteBooking = async (bookingId) => {
            try {
                let bookingToDelete = null;
                let bookingDate = null;
                
                for (const date in state.data.bookings) {
                    const bookingIndex = state.data.bookings[date].findIndex(b => b.id == bookingId);
                    if (bookingIndex !== -1) {
                        bookingToDelete = state.data.bookings[date][bookingIndex];
                        bookingDate = date;
                        break;
                    }
                }
                
                if (!bookingToDelete) {
                    showAlert('ไม่พบข้อมูลการจองคิวที่ต้องการลบ');
                    return;
                }
                
                state.data.bookings[bookingDate] = state.data.bookings[bookingDate].filter(b => b.id != bookingId);
                
                if (state.data.bookings[bookingDate].length === 0) {
                    delete state.data.bookings[bookingDate];
                }
                
                await setDoc(docRef, state.data);
                
                showAlert('ลบคิวสำเร็จแล้ว');
                
                render();
                
            } catch (error) {
                console.error('Error deleting booking:', error);
                showAlert('เกิดข้อผิดพลาดในการลบคิว กรุณาลองใหม่');
            }
        };
        
        const init = async () => {
            await signInAnonymously(auth);

            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    state.data = docSnap.data();
                    if (!state.data.companies || state.data.companies.length === 0) {
                        state.data.companies = initialCompanies;
                    }
                     if (!state.data.bookings) {
                         state.data.bookings = {};
                    }
                    if (!state.data.holidays) {
                        state.data.holidays = [];
                    }
                    if (!state.data.users) {
                        state.data.users = [];
                    }
                    if (!state.data.chats) {
                        state.data.chats = [];
                    }
                    if (!state.data.notifications) {
                        state.data.notifications = [];
                    }
                } else {
                    const initialData = { 
                        companies: initialCompanies, 
                        bookings: {}, 
                        holidays: [],
                        users: [],
                        chats: [],
                        notifications: []
                    };
                    setDoc(docRef, initialData); 
                }
                state.guestBookingIds = JSON.parse(sessionStorage.getItem('guestBookingIds')) || [];
                
                // อัปเดตจำนวนการแจ้งเตือนที่ยังไม่ได้อ่าน
                updateUnreadNotifications();
                
                // ตั้งค่าระบบแจ้งเตือนอัตโนมัติ
                setupAutomaticNotifications();
                
                // ขอสิทธิ์การแจ้งเตือน
                requestNotificationPermission();
                
                // เพิ่มการตั้งค่าแชทแบบเรียลไทม์
                setupRealtimeChat();
                
                render();
            });

            state.userRole = 'guest';
            state.isLoggedIn = false;
            state.currentView = 'calendar';
        };

        init();
    </script>
</body>
</html>
